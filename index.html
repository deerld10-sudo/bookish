<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Reading Journal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Библиотека для генерации PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --tg-bg: #1A1A1C;
            --tg-sec-bg: #2c2c2e;
            --tg-text: #ffffff;
            --tg-hint: #8e8e93;
            --tg-accent: #85BC41; 
            --rating-red: rgba(208, 47, 47, 0.6);
            --rating-blue: rgba(46, 78, 220, 0.6);
            --rating-green: rgba(133, 188, 65, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            min-height: 100vh; overflow-x: hidden;
        }

        .top-nav {
            position: sticky; top: 0;
            background-color: var(--tg-bg); z-index: 100;
            padding: 10px 16px; display: flex; align-items: center; gap: 12px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }

        .nav-items-wrapper { display: flex; gap: 8px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav-items-wrapper.hidden { display: none; }
        .nav-items-wrapper::-webkit-scrollbar { display: none; }

        .nav-item {
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            white-space: nowrap; background-color: var(--tg-sec-bg); color: var(--tg-hint);
            transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { background-color: var(--tg-text); color: var(--tg-bg); }

        .btn-add-top { background: none; border: none; cursor: pointer; color: var(--tg-accent); font-size: 13px; font-weight: 600; white-space: nowrap; }

        #app { flex: 1; padding: 16px; }
        .section { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        .book-shelf { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; 
            max-width: 1400px; margin: 0 auto; 
        }
        @media (min-width: 600px) { .book-shelf { grid-template-columns: repeat(4, 1fr); gap: 25px; } }
        @media (min-width: 1024px) { .book-shelf { grid-template-columns: repeat(6, 1fr); gap: 25px; } }

        .book-card { position: relative; cursor: pointer; transition: 0.2s; }
        .book-card:active { transform: scale(0.96); }
        .book-cover { 
            width: 100%; aspect-ratio: 2/3; background-color: var(--tg-sec-bg); 
            border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.4); position: relative; 
        }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; image-rendering: high-quality; }
        .book-date-badge { position: absolute; bottom: 8px; left: 8px; font-size: 10px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; color: #fff; backdrop-filter: blur(4px); }
        
        /* Белые цифры рейтинга на карточке */
        .rating-badge { 
            position: absolute; top: 8px; right: 8px; font-size: 11px; font-weight: 700; 
            padding: 2px 6px; border-radius: 4px; color: #ffffff; z-index: 2; 
        }
        .rating-red { background-color: var(--rating-red); }
        .rating-blue { background-color: var(--rating-blue); }
        .rating-green { background-color: var(--rating-green); }

        .add-card { border: 2px dashed var(--tg-hint); background: transparent !important; display: flex; align-items: center; justify-content: center; }
        .add-card span { font-size: 40px; color: var(--tg-hint); }
        .group-title { font-size: 18px; font-weight: 700; margin: 16px 0; display: flex; align-items: baseline; gap: 10px; }

        /* Форма создания */
        .add-form { display: flex; flex-direction: column; gap: 24px; padding-bottom: 50px; }
        .form-header { display: grid; grid-template-columns: 120px 1fr; gap: 20px; }
        .cover-upload { 
            width: 120px; aspect-ratio: 2/3; border-radius: 8px; border: 2px dashed var(--tg-hint); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; padding: 10px; font-size: 11px; color: var(--tg-hint); cursor: pointer; line-height: 1.3;
        }
        .cover-upload img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .form-inputs { display: flex; flex-direction: column; gap: 12px; }
        .form-inputs input { background: var(--tg-sec-bg); border: none; border-radius: 8px; padding: 10px 12px; color: var(--tg-text); font-size: 14px; outline: none; }
        .form-inputs input::placeholder { color: var(--tg-hint); font-style: italic; font-size: 13px; }
        .form-date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .custom-select-wrapper { position: relative; background: var(--tg-sec-bg); border-radius: 8px; overflow: hidden; }
        .custom-select-wrapper select { width: 100%; background: transparent; border: none; padding: 10px 30px 10px 12px; color: var(--tg-text); font-size: 14px; outline: none; -webkit-appearance: none; appearance: none; cursor: pointer; }
        .select-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; width: 12px; height: 12px; color: var(--tg-hint); opacity: 0.6; }

        /* Облако и вопросы */
        .questions-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
        .q-chip { padding: 6px 12px; background: var(--tg-sec-bg); border-radius: 14px; font-size: 13px; cursor: pointer; margin: 4px; display: inline-block; transition: 0.2s; }
        .q-chip.selected { background: var(--tg-accent); color: #fff; }

        .q-item { background: var(--tg-sec-bg); border-radius: 12px; padding: 12px; margin-bottom: 12px; position: relative; }
        .q-item label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--tg-hint); font-style: italic; padding-right: 30px; }
        .q-item .custom-q-label-input { 
            background: transparent; border: none; color: var(--tg-hint); font-size: 13px; font-weight: 600; 
            font-style: italic; margin-bottom: 8px; width: calc(100% - 30px); outline: none;
        }
        .q-item textarea { width: 100%; background: transparent; border: none; border-left: 2px solid var(--tg-accent); padding-left: 10px; color: var(--tg-text); font-size: 15px; resize: none; outline: none; min-height: 80px; }
        .q-item .delete-q-btn { position: absolute; top: 12px; right: 12px; color: var(--tg-accent); cursor: pointer; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; }
        .q-item .delete-q-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* Рейтинги */
        .ratings-container { display: flex; flex-direction: column; gap: 24px; }
        .rating-row { display: flex; flex-direction: column; gap: 10px; }
        .rating-info { display: flex; justify-content: space-between; font-size: 14px; } 
        .rating-slider { width: 100%; -webkit-appearance: none; height: 4px; background: var(--tg-sec-bg); border-radius: 2px; }
        .rating-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--tg-accent); border-radius: 50%; cursor: pointer; }

        /* Кнопки */
        .btn-base {
            padding: 12px; border-radius: 10px; font-size: 11px; font-weight: 700; cursor: pointer; text-align: center;
            border: 1px solid var(--tg-accent); text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .save-btn { background: var(--tg-accent); color: #fff; width: 100%; margin-top: 20px; }
        .btn-mini-action { background: transparent; color: var(--tg-accent); min-height: 44px; }
        .btn-mini-action.fill { background: var(--tg-accent); color: #fff; }
        .btn-mini-action svg { width: 20px; height: 20px; fill: currentColor; }

        /* Просмотр конспекта */
        .view-note { background: var(--tg-bg); line-height: 1.6; padding-bottom: 80px; }
        .view-header-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 30px; border-bottom: 0.5px solid rgba(255,255,255,0.1); padding-bottom: 25px; }
        .view-book-side { display: flex; gap: 20px; flex: 1; align-items: flex-start; }
        .view-cover-fixed { width: 165px; flex-shrink: 0; position: relative; } 
        .view-info-text { flex: 1; }
        .view-info-text h1 { font-size: 18px; margin: 0 0 8px 0; font-weight: 700; }
        .view-info-text h2 { font-size: 15px; color: var(--tg-hint); margin: 0 0 6px 0; font-weight: 600; } 
        
        .view-actions-side { display: flex; flex-direction: column; gap: 10px; width: 140px; flex-shrink: 0; }

        .note-qa-item { margin-bottom: 24px; }
        .note-qa-item .q { font-style: italic; color: var(--tg-hint); font-size: 13px; display: block; margin-bottom: 6px; }
        .note-qa-item .a { font-size: 15px; white-space: pre-wrap; line-height: 1.5; }

        .view-detailed-ratings { margin-top: 30px; border-top: 0.5px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .view-rating-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 14px; }

        @media (max-width: 600px) {
            .view-header-flex { flex-direction: column; align-items: center; text-align: center; }
            .view-book-side { flex-direction: column; align-items: center; }
            .view-actions-side { 
                flex-direction: row; width: 100%; justify-content: center; 
                margin: 30px 0; border-bottom: none; 
            }
            .btn-mini-action span { display: none; }
        }

        /* PDF Styles */
        .pdf-export-mode { background-color: #ffffff !important; color: #000000 !important; }
        .pdf-export-mode #note-details { width: 750px !important; margin: 0 auto !important; padding: 40px !important; background-color: #ffffff !important; overflow: visible !important; }
        .pdf-export-mode .view-header-flex { flex-direction: row !important; text-align: left !important; border-bottom-color: #eeeeee !important; }
        .pdf-export-mode .view-book-side { flex-direction: row !important; gap: 25px !important; }
        .pdf-export-mode .rating-badge { color: #ffffff !important; border: none !important; position: absolute !important; top: 5px !important; right: 5px !important; }
        .pdf-export-mode .view-rating-item { display: flex !important; justify-content: space-between !important; align-items: center !important; width: 100% !important; margin-bottom: 10px !important; border-bottom: 0.5px solid #f5f5f5; padding-bottom: 4px; }
        .pdf-export-mode .note-qa p { font-size: 14px !important; color: #666666 !important; }
        .pdf-divider { display: none; border-bottom: 0.5px solid #eeeeee; margin: 25px 0; }
        .pdf-export-mode .pdf-divider { display: block !important; }
        .pdf-export-mode .view-actions-side { display: none !important; }
    </style>
</head>
<body>

    <div class="top-nav" id="main-nav">
        <div class="nav-items-wrapper" id="nav-tabs">
            <div class="nav-item active" data-tab="all" onclick="window.switchTab('all')">Все</div>
            <div class="nav-item" data-tab="months" onclick="window.switchTab('months')">Месяцы</div>
            <div class="nav-item" data-tab="authors" onclick="window.switchTab('authors')">Авторы</div>
            <div class="nav-item" data-tab="tags" onclick="window.switchTab('tags')">Хэштеги</div>
        </div>
        <button class="btn-add-top" id="btn-add-global" onclick="window.openAddForm()">+ Книга</button>
    </div>

    <div id="app">
        <div id="tab-all" class="section">
            <div class="book-shelf" id="shelf-all"></div>
        </div>
        <div id="tab-months" class="section hidden">
            <div id="shelf-months"></div>
        </div>
        <div id="tab-authors" class="section hidden">
            <div id="shelf-authors"></div>
        </div>
        <div id="tab-tags" class="section hidden">
            <div id="shelf-tags"></div>
        </div>

        <!-- Форма -->
        <div id="tab-add" class="section hidden">
            <div class="add-form">
                <div class="form-header">
                    <input type="file" id="cover-input" hidden accept="image/*" onchange="window.previewImage(this)">
                    <div class="cover-upload" onclick="document.getElementById('cover-input').click()" id="cover-preview-container">
                        <span>Загрузить<br>обложку</span>
                    </div>
                    <div class="form-inputs">
                        <input type="text" id="f-title" placeholder="Название книги">
                        <input type="text" id="f-author" placeholder="Автор (через запятую)">
                        <input type="text" id="f-genre" placeholder="Жанр">
                        <input type="text" id="f-tags" placeholder="Хэштеги (через запятую)">
                        <div class="form-date-row">
                            <div class="custom-select-wrapper">
                                <select id="f-month">
                                    <option>Январь</option><option>Февраль</option><option>Март</option>
                                    <option>Апрель</option><option>Май</option><option>Июнь</option>
                                    <option>Июль</option><option>Август</option><option>Сентябрь</option>
                                    <option>Октябрь</option><option>Ноябрь</option><option>Декабрь</option>
                                </select>
                                <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                            <div class="custom-select-wrapper">
                                <select id="f-year"></select>
                                <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="group-title">Облако вопросов</div>
                    <div class="questions-cloud" id="q-cloud"></div>
                    <div id="selected-questions"></div>
                    <button class="btn-base btn-mini-action" style="width:100%; border-radius:10px" onclick="window.addCustomQuestion()">+ Свой вопрос</button>
                </div>
                <div>
                    <div class="group-title">Рейтинг книги</div>
                    <div class="ratings-container" id="ratings-list"></div>
                </div>
                <button class="btn-base save-btn" onclick="window.saveBook()">СОХРАНИТЬ КОНСПЕКТ</button>
            </div>
        </div>

        <div id="tab-view" class="section hidden">
            <div class="view-note" id="note-details"></div>
        </div>
    </div>

    <script>
        // Активация Telegram WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const iconTrash = '<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><g><path d="M62.205,150l26.569,320.735C90.678,493.865,110.38,512,133.598,512h244.805c23.218,0,42.92-18.135,44.824-41.265 L449.795,150H62.205z M180.986,452c-7.852,0-14.458-6.108-14.956-14.063l-15-242c-0.513-8.276,5.771-15.395,14.033-15.908 c8.569-0.601,15.381,5.757,15.908,14.033l15,242C196.502,444.632,189.721,452,180.986,452z M271,437c0,8.291-6.709,15-15,15 c-8.291,0-15-6.709-15-15V195c0-8.291,6.709-15,15-15s15,6.709,15,15V437z M360.97,195.938l-15,242 c-0.493,7.874-7.056,14.436-15.908,14.033c-8.262-0.513-14.546-7.632-14.033-15.908l15-242 c0.513-8.276,7.764-14.297,15.908-14.033C355.199,180.543,361.483,187.662,360.97,195.938z"></path></g><g><path d="M451,60h-90V45c0-24.814-20.186-45-45-45H196c-24.814,0-45,20.186-45,45v15H61c-16.569,0-30,13.431-30,30 c0,16.567,13.431,30,30,30c137.966,0,252.039,0,390,0c16.569,0,30-13.433,30-30C481,73.431,467.569,60,451,60z M331,60H181V45 c0-8.276,6.724-15,15-15h120c8.276,0,15,6.724,15,15V60z"></path></g></svg>';
        const iconEdit = '<svg viewBox="0 0 512 511" xmlns="http://www.w3.org/2000/svg"><path d="m405.332031 256.484375c-11.796875 0-21.332031 9.558594-21.332031 21.332031v170.667969c0 11.753906-9.558594 21.332031-21.332031 21.332031h-298.667969c-11.777344 0-21.332031-9.578125-21.332031-21.332031v-298.667969c0-11.753906 9.554687-21.332031 21.332031-21.332031h170.667969c11.796875 0 21.332031-9.558594 21.332031-21.332031 0-11.777344-9.535156-21.335938-21.332031-21.335938h-170.667969c-35.285156 0-64 28.714844-64 64v298.667969c0 35.285156 28.714844 64 64 64h298.667969c35.285156 0 64-28.714844 64-64v-170.667969c0-11.796875-9.539063-21.332031-21.335938-21.332031zm0 0"></path><path d="m200.019531 237.050781c-1.492187 1.492188-2.496093 3.390625-2.921875 5.4375l-15.082031 75.4375c-.703125 3.496094.40625 7.101563 2.921875 9.640625 2.027344 2.027344 4.757812 3.113282 7.554688 3.113282.679687 0 1.386718-.0625 2.089843-.210938l75.414063-15.082031c2.089844-.429688 3.988281-1.429688 5.460937-2.925781l168.789063-168.789063-75.414063-75.410156zm0 0"></path><path d="m496.382812 16.101562c-20.796874-20.800781-54.632812-20.800781-75.414062 0l-29.523438 29.523438 75.414063 75.414062 29.523437-29.527343c10.070313-10.046875 15.617188-23.445313 15.617188-37.695313s-5.546875-27.648437-15.617188-37.714844zm0 0"></path></svg>';
        const iconPdf = '<svg enable-background="new 0 0 515.283 515.283" viewBox="0 0 515.283 515.283" xmlns="http://www.w3.org/2000/svg"><g><path d="m400.775 515.283h-286.268c-30.584 0-59.339-11.911-80.968-33.54-21.628-21.626-33.539-50.382-33.539-80.968v-28.628c0-15.811 12.816-28.628 28.627-28.628s28.627 12.817 28.627 28.628v28.628c0 15.293 5.956 29.67 16.768 40.483 10.815 10.814 25.192 16.771 40.485 16.771h286.268c15.292 0 29.669-5.957 40.483-16.771 10.814-10.815 16.771-25.192 16.771-40.483v-28.628c0-15.811 12.816-28.628 28.626-28.628s28.628 12.817 28.628 28.628v28.628c0 30.584-11.911 59.338-33.54 80.968-21.629 21.629-50.384 33.54-80.968 33.54zm-143.134-114.509c-3.96 0-7.73-.804-11.16-2.257-3.2-1.352-6.207-3.316-8.838-5.885-.001-.001-.001-.002-.002-.002-.019-.018-.038-.037-.057-.056-.005-.004-.011-.011-.016-.016-.016-.014-.03-.029-.045-.044-.01-.01-.019-.018-.029-.029-.01-.01-.023-.023-.032-.031-.02-.02-.042-.042-.062-.062l-114.508-114.509c-11.179-11.179-11.179-29.305 0-40.485 11.179-11.179 29.306-11.18 40.485 0l65.638 65.638v-274.409c-.001-15.811 12.815-28.627 28.626-28.627s28.628 12.816 28.628 28.627v274.408l65.637-65.637c11.178-11.179 29.307-11.179 40.485 0 11.179 11.179 11.179 29.306 0 40.485l-114.508 114.507c-.02.02-.042.042-.062.062-.011.01-.023.023-.032.031-.01.011-.019.019-.029.029-.014.016-.03.03-.044.044-.005.005-.012.012-.017.016-.018.019-.037.038-.056.056-.001 0-.001.001-.002.002-.315.307-.634.605-.96.895-2.397 2.138-5.067 3.805-7.89 4.995-.01.004-.018.008-.028.012-.011.004-.02.01-.031.013-3.412 1.437-7.158 2.229-11.091 2.229z" fill="currentColor"></path></g></svg>';

        const questionsPool = ["кто главные персонажи и какую роль они играют?", "какие отношения или конфликты лежат в основе истории?", "о чём эта книга в целом?", "какую историю она рассказывает?", "какие темы и идеи в ней ключевые?", "как автор выстраивает сюжет или структуру повествования?", "почему я взялась(лся) за эту книгу?", "какое было настроение во время чтения?", "в какой момент текст начал увлекать?", "что в книге показалось самым сильным?", "какие сцены или мысли запомнились больше всего?", "какие вопросы поднимает автор?", "как раскрываются персонажи или центральные образы?", "с кем из героев или позиций я себя соотнёс(лась)?", "какие эмоции книга вызвала?", "где откликнулось сильнее всего?", "что вызвало сопротивление или несогласие?", "какую мысль я уношу с собой?", "изменилось ли моё восприятие темы после прочтения?", "как книга пересеклась с моим личным опытом?", "в каком жизненном контексте она читается особенно точно?", "какое послевкусие осталось после финала?", "кому и зачем я бы порекомендовал(а) эту книгу?"];
        const ratingCriteria = ["Сюжет и интрига", "Персонажи и их развитие", "Стиль и язык", "Эмоциональное воздействие", "Оригинальность", "Темп и динамика", "Атмосфера и мир", "Польза и познавательность", "Перечитываемость", "Концовка"];
        const monthIndices = { 'Январь': 0, 'Февраль': 1, 'Март': 2, 'Апрель': 3, 'Май': 4, 'Июнь': 5, 'Июль': 6, 'Август': 7, 'Сентябрь': 8, 'Октябрь': 9, 'Ноябрь': 10, 'Декабрь': 11 };

        let books = [];
        let currentSort = 'date'; // Дефолт по дате (2026 выше 2025)
        let currentEditingId = null;
        let selectedCoverBase64 = null;

        // Глобальный переключатель вкладок
        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.remove('hidden');
            
            const sortBtn = document.getElementById('btn-sort-global');
            const addBtn = document.getElementById('btn-add-global');
            const navTabs = document.getElementById('nav-tabs');

            if (tabId === 'add' || tabId === 'view') {
                navTabs.classList.add('hidden');
                sortBtn.classList.add('hidden');
                addBtn.innerText = "Назад";
                addBtn.onclick = () => window.switchTab('all');
            } else {
                navTabs.classList.remove('hidden');
                sortBtn.classList.remove('hidden');
                addBtn.innerText = "+ Книга";
                addBtn.onclick = () => window.openAddForm();
                document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.tab === tabId));
            }
            renderCurrentTab();
        };

        function renderCurrentTab() {
            const activeTab = document.querySelector('.nav-item.active')?.dataset.tab || 'all';
            if (activeTab === 'all') renderAll();
            else if (activeTab === 'months') renderMonths();
            else if (activeTab === 'authors') renderAuthors();
            else if (activeTab === 'tags') renderTags();
        }

        // Логика сортировки для разных разделов
        function getSortedBooks(arr, mode) {
            let sorted = [...arr];
            const activeTab = document.querySelector('.nav-item.active')?.dataset.tab || 'all';

            // Авторы и Тэги всегда по алфавиту
            if (activeTab === 'authors' || activeTab === 'tags') {
                sorted.sort((a, b) => a.title.localeCompare(b.title));
            } 
            // Все и Месяцы - по дате (новые выше) или выбранному режиму
            else {
                if (mode === 'title') {
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                } else if (mode === 'date') {
                    sorted.sort((a, b) => {
                        if (b.year !== a.year) return parseInt(b.year) - parseInt(a.year);
                        return monthIndices[b.month] - monthIndices[a.month];
                    });
                }
                // 'recent' - порядок добавления (по умолчанию)
            }
            return sorted;
        }

        window.toggleSortMenu = () => {
            Telegram.WebApp.showActionSheet({
                title: 'Сортировка конспектов',
                buttons: [
                    {id: 'date', text: 'По дате чтения (Новые сверху)'},
                    {id: 'title', text: 'По названию (А-Я)'},
                    {id: 'recent', text: 'По недавним (порядку добавления)'}
                ]
            }, (btnId) => { if(btnId) { currentSort = btnId; renderCurrentTab(); } });
        };

        window.openAddForm = (bookId = null) => {
            currentEditingId = bookId;
            window.switchTab('add');
            populateYears();
            
            document.getElementById('f-title').value = '';
            document.getElementById('f-author').value = '';
            document.getElementById('f-genre').value = '';
            document.getElementById('f-tags').value = '';
            document.getElementById('selected-questions').innerHTML = '';
            selectedCoverBase64 = null;
            document.getElementById('cover-preview-container').innerHTML = `<span>Загрузить<br>обложку</span>`;

            const book = bookId ? books.find(b => b.id === bookId) : null;
            
            document.getElementById('q-cloud').innerHTML = questionsPool.map(q => {
                const sel = book && book.answers && book.answers[q];
                return `<div class="q-chip ${sel ? 'selected' : ''}" onclick="window.toggleQuestion(this, '${q.replace(/'/g, "\\'")}')">${q}</div>`;
            }).join('');

            document.getElementById('ratings-list').innerHTML = ratingCriteria.map((c, i) => {
                const val = (book && book.criteria) ? book.criteria[i] : 5;
                return `<div class="rating-row"><div class="rating-info"><span>${c}</span><span id="rv-${i}">${val}</span></div><input type="range" class="rating-slider" min="1" max="10" value="${val}" oninput="window.updateRatingVal(${i}, this.value)"></div>`;
            }).join('');

            if (book) {
                document.getElementById('f-title').value = book.title || '';
                document.getElementById('f-author').value = book.author || '';
                document.getElementById('f-genre').value = book.genre || '';
                document.getElementById('f-tags').value = (book.tags || []).join(', ');
                document.getElementById('f-month').value = book.month || 'Январь';
                document.getElementById('f-year').value = book.year || new Date().getFullYear();
                if(book.img) {
                    selectedCoverBase64 = book.img;
                    document.getElementById('cover-preview-container').innerHTML = `<img src="${book.img}">`;
                }
                if(book.answers) {
                    Object.keys(book.answers).forEach(q => {
                        const isPredefined = questionsPool.includes(q);
                        addQuestionToContainer(q, book.answers[q], !isPredefined);
                    });
                }
            }
        };

        window.saveBook = () => {
            const criteria = Array.from(document.querySelectorAll('.rating-slider')).map(s => parseInt(s.value));
            const avg = (criteria.reduce((a, b) => a + b, 0) / 10).toFixed(1);
            const answers = {};
            document.querySelectorAll('.q-item').forEach(item => {
                const labelEl = item.querySelector('label') || item.querySelector('.custom-q-label-input');
                const label = (labelEl.tagName === 'INPUT') ? labelEl.value : labelEl.innerText;
                const text = item.querySelector('textarea').value;
                if(label && label.trim()) answers[label] = text;
            });

            const bookData = {
                id: currentEditingId || Date.now().toString(),
                title: document.getElementById('f-title').value || 'Без названия',
                author: document.getElementById('f-author').value || 'Неизвестен',
                genre: document.getElementById('f-genre').value || '',
                month: document.getElementById('f-month').value,
                year: document.getElementById('f-year').value,
                rating: avg,
                img: selectedCoverBase64 || '',
                tags: document.getElementById('f-tags').value.split(',').map(t => t.trim().startsWith('#') ? t.trim() : '#' + t.trim()).filter(t => t !== '#'),
                answers, criteria
            };

            if (currentEditingId) books = books.map(b => b.id === currentEditingId ? bookData : b);
            else books.unshift(bookData);
            
            localStorage.setItem('reading_journal_data', JSON.stringify(books));
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            window.switchTab('all');
        };

        window.addCustomQuestion = () => {
            addQuestionToContainer('', '', true);
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
        };

        function addQuestionToContainer(q, val, isCustom = false) {
            const container = document.getElementById('selected-questions');
            const id = isCustom ? ('custom-' + Date.now() + Math.random()) : ('q-field-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, ''));
            if (!isCustom && document.getElementById(id)) return;
            const item = document.createElement('div');
            item.className = 'q-item';
            item.id = id;
            item.innerHTML = isCustom 
                ? `<input type="text" class="custom-q-label-input" value="${q}" placeholder="Введите свой вопрос"><div class="delete-q-btn" onclick="this.parentElement.remove()">${iconTrash}</div><textarea placeholder="Ваш ответ...">${val}</textarea>`
                : `<label>${q}</label><textarea placeholder="Ваш ответ...">${val}</textarea>`;
            container.appendChild(item);
        }

        window.toggleQuestion = (el, q) => {
            el.classList.toggle('selected');
            const id = 'q-field-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, '');
            if (el.classList.contains('selected')) addQuestionToContainer(q, '', false);
            else document.getElementById(id)?.remove();
        };

        window.updateRatingVal = (id, val) => {
            const display = document.getElementById(`rv-${id}`);
            if(display) display.innerText = val;
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    selectedCoverBase64 = e.target.result;
                    document.getElementById('cover-preview-container').innerHTML = `<img src="${e.target.result}">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.viewBook = (id) => {
            const book = books.find(b => b.id === id);
            if (!book) return;
            const container = document.getElementById('note-details');
            const rClass = getRatingClass(book.rating);
            let qaHtml = '';
            if (book.answers && Object.keys(book.answers).length > 0) {
                Object.entries(book.answers).forEach(([q, a]) => { 
                    if(a && a.trim()) qaHtml += `<div class="note-qa-item"><span class="q">${q}</span><div class="a">${a}</div></div>`; 
                });
                qaHtml += `<div class="pdf-divider"></div>`;
            } else qaHtml = `<p style="color:var(--tg-hint); font-size: 14px; text-align:center">Конспект пуст...</p>`;
            
            let ratingsHtml = `<div class="view-detailed-ratings"><div class="group-title">Рейтинг книги</div><div class="pdf-ratings-list">`;
            ratingCriteria.forEach((name, i) => {
                const score = parseFloat(book.criteria ? book.criteria[i] : 0);
                ratingsHtml += `<div class="view-rating-item"><span>${name}:</span><span class="rating-badge-score">${score.toFixed(1)}</span></div>`;
            });
            ratingsHtml += '</div></div>';

            container.innerHTML = `
                <div class="view-header-flex">
                    <div class="view-book-side">
                        <div class="view-cover-fixed">
                            <div class="book-cover" style="box-shadow: 0 4px 15px rgba(0,0,0,0.4)">
                                <img src="${book.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'">
                                <div class="rating-badge ${rClass}">${parseFloat(book.rating).toFixed(1)}</div>
                            </div>
                        </div>
                        <div class="view-info-text">
                            <h1>${book.title}</h1>
                            <h2>${book.author}</h2>
                            <div style="color:var(--tg-hint); margin-top:4px; font-size:15px">
                                <span style="font-weight:600">${book.month}</span> 
                                <span style="font-size:13px; font-style:italic; margin-left:4px">${book.year}</span>
                            </div>
                        </div>
                    </div>
                    <div class="view-actions-side">
                        <button class="btn-base btn-mini-action fill" onclick="window.openAddForm('${book.id}')">${iconEdit}<span>Редактировать</span></button>
                        <button class="btn-base btn-mini-action" onclick="window.exportPDF('${book.title.replace(/[^a-z0-9]/gi, '_')}')">${iconPdf}<span>PDF</span></button>
                        <button class="btn-base btn-mini-action" onclick="window.deleteBook('${book.id}')">${iconTrash}<span>Удалить</span></button>
                    </div>
                </div>
                <div class="note-qa">${qaHtml}</div>
                ${ratingsHtml}
            `;
            window.switchTab('view');
        };

        window.exportPDF = async (bookTitle) => {
            const element = document.getElementById('note-details');
            try {
                document.body.classList.add('pdf-export-mode');
                const opt = {
                    margin: 10, filename: `Journal_${bookTitle}.pdf`, image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { scale: 3, useCORS: true, backgroundColor: '#ffffff', width: 820, onclone: (cloned) => {
                        const note = cloned.getElementById('note-details');
                        note.style.width = '750px'; note.style.margin = '0 auto'; note.style.padding = '40px';
                        const actions = cloned.querySelector('.view-actions-side');
                        if(actions) actions.style.display = 'none';
                        
                        // Выравнивание рейтинга в PDF: строчки параллельны
                        note.querySelectorAll('.view-rating-item').forEach(item => { 
                            item.style.display = 'flex'; 
                            item.style.justifyContent = 'space-between'; 
                            item.style.width = '100%';
                            item.style.marginBottom = '6px';
                            item.style.borderBottom = '0.5px solid #eee';
                            item.style.paddingBottom = '3px';
                        });
                        
                        // Цвет цифр на обложке в PDF - белый
                        const badge = note.querySelector('.rating-badge');
                        if (badge) {
                            badge.style.color = '#ffffff';
                            badge.style.backgroundColor = 'rgba(0,0,0,0.4)';
                        }
                    }}, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(opt).from(element).save();
            } finally { document.body.classList.remove('pdf-export-mode'); }
        };

        function getRatingClass(val) { const n = parseFloat(val); return n <= 4 ? 'rating-red' : (n <= 7 ? 'rating-blue' : 'rating-green'); }
        function createShelfBook(b) {
            const div = document.createElement('div'); div.className = 'book-card';
            div.onclick = () => window.viewBook(b.id);
            div.innerHTML = `<div class="rating-badge ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div><div class="book-cover"><img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'"><div class="book-date-badge">${b.month}</div></div>`;
            return div;
        }

        function renderAll() {
            const shelf = document.getElementById('shelf-all');
            shelf.innerHTML = '<div class="book-card" onclick="window.openAddForm()"><div class="book-cover add-card"><span>+</span></div></div>';
            getSortedBooks(books, currentSort).forEach(b => shelf.appendChild(createShelfBook(b)));
        }

        function renderMonths() {
            const shelf = document.getElementById('shelf-months'); shelf.innerHTML = '';
            const sorted = getSortedBooks(books, 'date');
            const years = [...new Set(sorted.map(b => b.year))].sort((a,b) => b-a);
            years.forEach(y => {
                const yearBooks = sorted.filter(b => b.year === y);
                const monthsInYear = [...new Set(yearBooks.map(b => b.month))].sort((a,b) => monthIndices[b] - monthIndices[a]);
                monthsInYear.forEach(m => {
                    const cont = document.createElement('div');
                    cont.innerHTML = `<div class="group-title">${m} <span style="font-size:14px; opacity:0.7; font-style:italic">${y}</span></div>`;
                    const grid = document.createElement('div'); grid.className = 'book-shelf';
                    yearBooks.filter(b => b.month === m).forEach(b => grid.appendChild(createShelfBook(b)));
                    cont.appendChild(grid); shelf.appendChild(cont);
                });
            });
        }
        
        function renderAuthors() {
            const shelf = document.getElementById('shelf-authors'); shelf.innerHTML = '';
            const sorted = getSortedBooks(books, 'title');
            let authorsList = []; 
            sorted.forEach(b => authorsList.push(...b.author.split(',').map(a => a.trim())));
            
            // Авторы всегда по алфавиту
            const uniqueAuthors = [...new Set(authorsList)].sort((a, b) => a.localeCompare(b));
            
            uniqueAuthors.forEach(a => {
                if(!a) return;
                const cont = document.createElement('div'); cont.innerHTML = `<div class="group-title">${a}</div>`;
                const grid = document.createElement('div'); grid.className = 'book-shelf';
                sorted.filter(b => b.author.split(',').map(p => p.trim()).includes(a)).forEach(b => grid.appendChild(createShelfBook(b)));
                cont.appendChild(grid); shelf.appendChild(cont);
            });
        }

        function renderTags() {
            const shelf = document.getElementById('shelf-tags'); shelf.innerHTML = '';
            const sorted = getSortedBooks(books, 'title');
            
            // Тэги всегда по алфавиту
            const tags = [...new Set(sorted.flatMap(b => b.tags || []))].filter(t => t).sort((a, b) => a.localeCompare(b));
            
            tags.forEach(t => {
                const cont = document.createElement('div'); cont.innerHTML = `<div class="group-title">${t}</div>`;
                const grid = document.createElement('div'); grid.className = 'book-shelf';
                sorted.filter(b => (b.tags || []).includes(t)).forEach(b => grid.appendChild(createShelfBook(b)));
                cont.appendChild(grid); shelf.appendChild(cont);
            });
        }

        function populateYears() {
            const yearSelect = document.getElementById('f-year');
            if(!yearSelect) return;
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear + 5; y >= 1950; y--) {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y;
                if (y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
        }

        window.deleteBook = (id) => {
            Telegram.WebApp.showPopup({
                title: 'Удаление', message: 'Вы действительно хотите удалить этот конспект?',
                buttons: [
                    {id: 'delete', type: 'destructive', text: 'Удалить'},
                    {id: 'cancel', type: 'cancel', text: 'Отмена'}
                ]
            }, (buttonId) => {
                if (buttonId === 'delete') {
                    books = books.filter(b => b.id !== id);
                    localStorage.setItem('reading_journal_data', JSON.stringify(books));
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.switchTab('all');
                }
            });
        };

        window.onload = () => {
            const saved = localStorage.getItem('reading_journal_data');
            if (saved) books = JSON.parse(saved);
            renderAll(); populateYears();
        };
    </script>
</body>
</html>
