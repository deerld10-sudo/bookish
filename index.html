<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Reading Journal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --tg-bg: #1A1A1C;
            --tg-sec-bg: #2c2c2e;
            --tg-text: #ffffff;
            --tg-hint: #8e8e93;
            --tg-accent: #85BC41; 
            --rating-red: rgba(208, 47, 47, 0.8);
            --rating-blue: rgba(46, 78, 220, 0.8);
            --rating-green: rgba(133, 188, 65, 0.8);
            --card-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            min-height: 100vh; overflow-x: hidden;
        }

        /* Navigation */
        .top-nav {
            position: sticky; top: 0;
            background-color: var(--tg-bg); z-index: 100;
            padding: 10px 16px; display: flex; align-items: center; gap: 12px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }

        .nav-items-wrapper { 
            display: flex; gap: 8px; flex: 1; 
            overflow-x: auto; scrollbar-width: none; 
            padding-bottom: 2px;
        }
        .nav-items-wrapper::-webkit-scrollbar { display: none; }
        .nav-items-wrapper.hidden { display: none !important; }

        .nav-item {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500;
            white-space: nowrap; background-color: var(--tg-sec-bg); color: var(--tg-hint);
            transition: all 0.2s ease; cursor: pointer;
        }
        .nav-item.active { background-color: var(--tg-text); color: var(--tg-bg); }

        .btn-add-top { 
            background: none; border: none; cursor: pointer; 
            color: var(--tg-accent); font-size: 14px; font-weight: 600; 
            white-space: nowrap; padding: 4px 8px;
        }

        /* Search Bar */
        .search-container {
            padding: 12px 16px; /* Updated: symmetrical spacing from divider */
            background: var(--tg-bg);
        }
        .search-input {
            width: 100%;
            background: var(--tg-sec-bg);
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--tg-text);
            font-size: 14px;
        }

        #app { flex: 1; padding: 16px; }
        .section { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* Grid Shelf */
        .book-shelf { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; 
            max-width: 1400px; margin: 0 auto; 
        }
        @media (min-width: 480px) { .book-shelf { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .book-shelf { grid-template-columns: repeat(4, 1fr); } }

        .book-card { position: relative; cursor: pointer; transition: transform 0.2s ease; }
        .book-card:active { transform: scale(0.95); }
        .book-cover { 
            width: 100%; aspect-ratio: 2/3; background-color: var(--tg-sec-bg); 
            border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); 
            position: relative; border: 0.5px solid rgba(255,255,255,0.05);
            z-index: 1;
        }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .book-date-badge { 
            position: absolute; bottom: 8px; left: 8px; font-size: 10px; 
            background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 6px; 
            color: #fff; backdrop-filter: blur(4px); font-weight: 500;
        }
        
        .rating-badge { 
            position: absolute; top: -8px; right: -8px; font-size: 11px; font-weight: 800; 
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: #ffffff; z-index: 10; border: 2px solid var(--tg-bg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .rating-red { background-color: var(--rating-red); }
        .rating-blue { background-color: var(--rating-blue); }
        .rating-green { background-color: var(--rating-green); }

        .group-title { 
            font-size: 18px; font-weight: 700; margin: 24px 0 12px 0; 
            display: flex; align-items: baseline; gap: 8px; 
            border-left: 3px solid var(--tg-accent); padding-left: 12px;
        }

        /* Rating Tab List Styles */
        .rating-list-container { display: flex; flex-direction: column; gap: 12px; }
        .rating-list-item { 
            display: flex; gap: 16px; background: var(--tg-sec-bg); 
            padding: 12px; border-radius: 16px; cursor: pointer;
            transition: background 0.2s;
        }
        .rating-list-item:active { background: rgba(255,255,255,0.05); }
        .rating-list-img { width: 70px; aspect-ratio: 2/3; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .rating-list-content { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .rl-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rl-author { font-size: 13px; color: var(--tg-hint); margin-bottom: 4px; }
        .rl-meta { font-size: 11px; color: var(--tg-hint); font-style: italic; margin-bottom: 6px; }
        .rl-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .rl-tag { font-size: 9px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; color: var(--tg-hint); }
        .rl-score-box { 
            display: flex; align-items: center; justify-content: center; 
            width: 36px; height: 36px; border-radius: 50%; color: #fff; font-weight: 800; font-size: 12px;
            flex-shrink: 0; margin-left: 8px; align-self: center;
        }

        /* Form Styles */
        .add-form { display: flex; flex-direction: column; gap: 24px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        .form-header { display: flex; gap: 20px; }
        .cover-upload { 
            width: 110px; flex-shrink: 0; aspect-ratio: 2/3; border-radius: 10px; 
            border: 2px dashed var(--tg-hint); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; padding: 10px; font-size: 11px; color: var(--tg-hint); 
            cursor: pointer; background: rgba(255,255,255,0.03);
        }
        .cover-upload img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        
        .form-inputs { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .form-inputs input { 
            background: var(--tg-sec-bg); border: none; border-radius: 10px; 
            padding: 12px; color: var(--tg-text); font-size: 14px; 
        }
        .form-inputs input::placeholder { color: var(--tg-hint); }
        
        .form-date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .custom-select-wrapper { position: relative; background: var(--tg-sec-bg); border-radius: 10px; }
        .custom-select-wrapper select { 
            width: 100%; background: transparent; border: none; padding: 12px; 
            color: var(--tg-text); font-size: 14px; appearance: none;
        }
        .select-icon { 
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
            pointer-events: none; width: 14px; height: 14px; opacity: 0.5;
        }

        /* Q&A Cloud */
        .questions-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .q-chip { 
            padding: 8px 14px; background: var(--tg-sec-bg); border-radius: 18px; 
            font-size: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .q-chip.selected { background: var(--tg-accent); color: #fff; font-weight: 500; }

        /* Q&A Item Form */
        .q-item { 
            background: var(--tg-sec-bg); border-radius: 14px; padding: 16px; 
            margin-bottom: 16px; position: relative; 
        }
        .q-item .q-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .q-item label, .custom-q-label-input { 
            display: block; font-size: 13px; font-weight: 700; 
            color: var(--tg-hint); font-style: italic;
        }
        .custom-q-label-input { 
            background: transparent; border: none; width: calc(100% - 30px); 
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px;
        }
        .q-item textarea { 
            width: 100%; background: transparent; border: none; 
            border-left: 2px solid var(--tg-accent);
            padding: 4px 0 4px 12px; color: var(--tg-text); 
            font-size: 15px; resize: none; min-height: 80px; line-height: 1.5; font-weight: 700;
        }
        .delete-q-btn { 
            color: var(--tg-accent); width: 20px; height: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .delete-q-btn svg { width: 100%; height: 100%; fill: currentColor; }

        /* Ratings */
        .rating-row { margin-bottom: 16px; }
        .rating-info { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: var(--tg-hint); }
        .rating-slider { 
            width: 100%; -webkit-appearance: none; height: 6px; 
            background: var(--tg-sec-bg); border-radius: 3px; 
        }
        .rating-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 22px; height: 22px; 
            background: var(--tg-accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Buttons */
        .btn-base {
            padding: 10px; border-radius: 12px; font-size: 13px; font-weight: 700; 
            cursor: pointer; text-align: center; border: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .save-btn { background: var(--tg-accent); color: #fff; width: 100%; margin-top: 20px; padding: 14px; }
        
        .btn-mini-action { background: var(--tg-sec-bg); color: var(--tg-text); border-radius: 10px; width: 44px; height: 44px; padding: 0; }
        .btn-mini-action.fill { background: var(--tg-accent); color: #fff; }
        .btn-mini-action svg { width: 20px; height: 20px; fill: currentColor; }

        /* View Note */
        .view-note { max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        .view-header-flex { 
            display: flex; gap: 24px; margin-bottom: 24px; 
            padding-bottom: 24px; border-bottom: 0.5px solid rgba(255,255,255,0.1); 
        }
        .view-cover-fixed { width: 140px; flex-shrink: 0; position: relative; }
        .view-info-text h1 { font-size: 22px; margin: 0 0 8px 0; }
        
        /* Headers in View: Author, Genre, Month - 16px. Year - 12px. */
        .view-info-text h2 { font-size: 16px; color: var(--tg-text); margin: 0 0 4px 0; font-weight: 500; }
        .view-genre { color: var(--tg-hint) !important; font-weight: 400 !important; font-size: 16px; margin-bottom: 4px; }
        .view-month { font-size: 16px; color: var(--tg-hint); display: inline-block; }
        .view-year { font-size: 12px; color: var(--tg-hint); font-style: italic; display: inline-block; margin-left: 4px; }
        
        .view-tag { font-size: 11px; background: var(--tg-sec-bg); padding: 4px 8px; border-radius: 6px; color: var(--tg-hint); }
        .view-tags-container { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }

        .view-actions-side { display: flex; gap: 12px; margin-bottom: 32px; align-items: center; }

        /* QA Display */
        .note-qa-item { margin-bottom: 24px; }
        .note-qa-item .q { 
            font-size: 13px; color: var(--tg-hint); font-style: italic; 
            display: block; margin-bottom: 6px; 
        }
        .note-qa-item .a { 
            font-size: 16px; line-height: 1.5; white-space: pre-wrap; color: #fff; font-weight: 700;
            border-left: 2px solid var(--tg-accent); padding-left: 12px;
        }

        .view-detailed-ratings { margin-top: 40px; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 24px; }
        .view-rating-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 0.5px solid rgba(255,255,255,0.05); }
        .view-rating-item:last-child { border-bottom: none; }
        .rating-badge-score { font-weight: 700; color: var(--tg-accent); }

        @media (max-width: 600px) {
            .view-header-flex { flex-direction: column; align-items: center; text-align: center; }
            .view-actions-side { justify-content: center; }
            .view-tags-container { justify-content: center; }
        }

        /* PDF Styles */
        .pdf-export-mode { background: #fff !important; color: #000 !important; }
        .pdf-export-mode #note-details { padding: 40px !important; color: #000 !important; }
        .pdf-export-mode .view-actions-side { display: none !important; }
        .pdf-export-mode .note-qa-item { border-bottom: 1px solid #eee; padding-bottom: 12px; }
        
        /* Unified font sizes for PDF */
        .pdf-export-mode .q, 
        .pdf-export-mode .a, 
        .pdf-export-mode .view-rating-item { 
            font-size: 14px !important; 
        }

        .pdf-export-mode .q { color: #888 !important; }
        .pdf-export-mode .a { color: #000 !important; border-left-color: #5a8c20 !important; }
        .pdf-export-mode .view-info-text h1 { color: #000 !important; }
        .pdf-export-mode .view-info-text h2 { color: #000 !important; } /* Author black */
        .pdf-export-mode .view-genre { color: #999 !important; }
        .pdf-export-mode .view-tag { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #eee; }
        
        /* Gray plate for ratings in PDF */
        .pdf-export-mode .view-detailed-ratings { 
            background: #f5f5f5 !important; 
            border: 1px solid #eee; 
            color: #000 !important; 
            padding: 20px !important;
            border-radius: 12px !important;
        }
        .pdf-export-mode .view-rating-item { border-bottom-color: #ddd; }
    </style>
</head>
<body>

    <div class="top-nav" id="main-nav">
        <div class="nav-items-wrapper" id="nav-tabs">
            <div class="nav-item active" data-tab="all" onclick="window.switchTab('all')">Все</div>
            <div class="nav-item" data-tab="rating" onclick="window.switchTab('rating')">Рейтинг</div>
            <div class="nav-item" data-tab="months" onclick="window.switchTab('months')">Месяцы</div>
            <div class="nav-item" data-tab="authors" onclick="window.switchTab('authors')">Авторы</div>
            <div class="nav-item" data-tab="tags" onclick="window.switchTab('tags')">Хэштеги</div>
        </div>
        <button class="btn-add-top" id="btn-add-global" onclick="window.openAddForm()">+ Книга</button>
    </div>

    <div class="search-container" id="search-bar-container">
        <input type="text" class="search-input" id="shelf-search" placeholder="Поиск по названию или автору..." oninput="window.renderCurrentTab()">
    </div>

    <div id="app">
        <!-- Main Shelves -->
        <div id="tab-all" class="section">
            <div class="book-shelf" id="shelf-all"></div>
        </div>
        <div id="tab-rating" class="section hidden">
            <div class="rating-list-container" id="shelf-rating"></div>
        </div>
        <div id="tab-months" class="section hidden">
            <div id="shelf-months"></div>
        </div>
        <div id="tab-authors" class="section hidden">
            <div id="shelf-authors"></div>
        </div>
        <div id="tab-tags" class="section hidden">
            <div id="shelf-tags"></div>
        </div>

        <!-- Add/Edit Form -->
        <div id="tab-add" class="section hidden">
            <div class="add-form">
                <div class="form-header">
                    <input type="file" id="cover-input" hidden accept="image/*" onchange="window.previewImage(this)">
                    <div class="cover-upload" onclick="document.getElementById('cover-input').click()" id="cover-preview-container">
                        <span>+<br>Обложка</span>
                    </div>
                    <div class="form-inputs">
                        <input type="text" id="f-title" placeholder="Название книги">
                        <input type="text" id="f-author" placeholder="Автор (через запятую)">
                        <input type="text" id="f-genre" placeholder="Жанр">
                        <input type="text" id="f-tags" placeholder="Хэштеги (через запятую)">
                        <div class="form-date-row">
                            <div class="custom-select-wrapper">
                                <select id="f-month">
                                    <option>Январь</option><option>Февраль</option><option>Март</option>
                                    <option>Апрель</option><option>Май</option><option>Июнь</option>
                                    <option>Июль</option><option>Август</option><option>Сентябрь</option>
                                    <option>Октябрь</option><option>Ноябрь</option><option>Декабрь</option>
                                </select>
                                <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                            <div class="custom-select-wrapper">
                                <select id="f-year"></select>
                                <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="group-title">Заметки и мысли</div>
                    <div class="questions-cloud" id="q-cloud"></div>
                    <div id="selected-questions"></div>
                    <button class="btn-base btn-mini-action" style="width:100%; border-radius:12px; height:auto; padding:12px;" onclick="window.addCustomQuestion()">+ Свой вопрос</button>
                </div>

                <div>
                    <div class="group-title">Рейтинг</div>
                    <div id="ratings-list"></div>
                </div>

                <button class="btn-base save-btn" onclick="window.saveBook()">СОХРАНИТЬ</button>
            </div>
        </div>

        <!-- View Mode -->
        <div id="tab-view" class="section hidden">
            <div id="note-details" class="view-note"></div>
        </div>
    </div>

    <script>
        const iconEdit = `<svg viewBox="0 0 512 511" xmlns="http://www.w3.org/2000/svg"><path d="m405.332031 256.484375c-11.796875 0-21.332031 9.558594-21.332031 21.332031v170.667969c0 11.753906-9.558594 21.332031-21.332031 21.332031h-298.667969c-11.777344 0-21.332031-9.578125-21.332031-21.332031v-298.667969c0-11.753906 9.554687-21.332031 21.332031-21.332031h170.667969c11.796875 0 21.332031-9.558594 21.332031-21.332031 0-11.777344-9.535156-21.335938-21.332031-21.335938h-170.667969c-35.285156 0-64 28.714844-64 64v298.667969c0 35.285156 28.714844 64 64 64h298.667969c35.285156 0 64-28.714844 64-64v-170.667969c0-11.796875-9.539063-21.332031-21.335938-21.332031zm0 0"></path><path d="m200.019531 237.050781c-1.492187 1.492188-2.496093 3.390625-2.921875 5.4375l-15.082031 75.4375c-.703125 3.496094.40625 7.101563 2.921875 9.640625 2.027344 2.027344 4.757812 3.113282 7.554688 3.113282.679687 0 1.386718-.0625 2.089843-.210938l75.414063-15.082031c2.089844-.429688 3.988281-1.429688 5.460937-2.925781l168.789063-168.789063-75.414063-75.410156zm0 0"></path><path d="m496.382812 16.101562c-20.796874-20.800781-54.632812-20.800781-75.414062 0l-29.523438 29.523438 75.414063 75.414062 29.523437-29.527343c10.070313-10.046875 15.617188-23.445313 15.617188-37.695313s-5.546875-27.648437-15.617188-37.714844zm0 0"></path></svg>`;
        const iconPdf = `<svg enable-background="new 0 0 515.283 515.283" viewBox="0 0 515.283 515.283" xmlns="http://www.w3.org/2000/svg"><path d="m400.775 515.283h-286.268c-30.584 0-59.339-11.911-80.968-33.54-21.628-21.626-33.539-50.382-33.539-80.968v-28.628c0-15.811 12.816-28.628 28.627-28.628s28.627 12.817 28.627 28.628v28.628c0 15.293 5.956 29.67 16.768 40.483 10.815 10.814 25.192 16.771 40.485 16.771h286.268c15.292 0 29.669-5.957 40.483-16.771 10.814-10.815 16.771-25.192 16.771-40.483v-28.628c0-15.811 12.816-28.628 28.626-28.628s28.628 12.817 28.628 28.628v28.628c0 30.584-11.911 59.338-33.54 80.968-21.629 21.629-50.384 33.54-80.968 33.54zm-143.134-114.509c-3.96 0-7.73-.804-11.16-2.257-3.2-1.352-6.207-3.316-8.838-5.885-.001-.001-.001-.002-.002-.002-.019-.018-.038-.037-.057-.056-.005-.004-.011-.011-.016-.016-.016-.014-.03-.029-.045-.044-.01-.01-.019-.018-.029-.029-.01-.01-.023-.023-.032-.031-.02-.02-.042-.042-.062-.062l-114.508-114.509c-11.179-11.179-11.179-29.305 0-40.485 11.179-11.179 29.306-11.18 40.485 0l65.638 65.638v-274.409c-.001-15.811 12.815-28.627 28.626-28.627s28.628 12.816 28.628 28.627v274.408l65.637-65.637c11.178-11.179 29.307-11.179 40.485 0 11.179 11.179 11.179 29.306 0 40.485l-114.508 114.507c-.02.02-.042.042-.062.062-.011.01-.023.023-.032.031-.01.011-.019.019-.029.029-.014.016-.03.03-.044.044-.005.005-.012.012-.017.016-.018.019-.037.038-.056.056-.001 0-.001.001-.002.002-.315.307-.634.605-.96.895-2.397 2.138-5.067 3.805-7.89 4.995-.01.004-.018.008-.028.012-.011.004-.02.01-.031.013-3.412 1.437-7.158 2.229-11.091 2.229z" fill="currentColor"></path></svg>`;
        const iconTrash = `<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><g><path d="M62.205,150l26.569,320.735C90.678,493.865,110.38,512,133.598,512h244.805c23.218,0,42.92-18.135,44.824-41.265 L449.795,150H62.205z M180.986,452c-7.852,0-14.458-6.108-14.956-14.063l-15-242c-0.513-8.276,5.771-15.395,14.033-15.908 c8.569-0.601,15.381,5.757,15.908,14.033l15,242C196.502,444.632,189.721,452,180.986,452z M271,437c0,8.291-6.709,15-15,15 c-8.291,0-15-6.709-15-15V195c0-8.291,6.709-15,15-15s15,6.709,15,15V437z M360.97,195.938l-15,242 c-0.493,7.874-7.056,14.436-15.908,14.033c-8.262-0.513-14.546-7.632-14.033-15.908l15-242 c0.513-8.276,7.764-14.297,15.908-14.033C355.199,180.543,361.483,187.662,360.97,195.938z"></path></g><g><path d="M451,60h-90V45c0-24.814-20.186-45-45-45H196c-24.814,0-45,20.186-45,45v15H61c-16.569,0-30,13.431-30,30 c0,16.567,13.431,30,30,30c137.966,0,252.039,0,390,0c16.569,0,30-13.433,30-30C481,73.431,467.569,60,451,60z M331,60H181V45 c0-8.276,6.724-15,15-15h120c8.276,0,15,6.724,15,15V60z"></path></g></svg>`;

        const questionsPool = ["О чём эта книга в целом?", "Какие темы и идеи ключевые?", "Что показалось самым сильным?", "Главные персонажи и их роль?", "Какие сцены запомнились?", "Какие эмоции книга вызвала?", "Что вызвало несогласие?", "Какую мысль я уношу с собой?", "Кому бы я порекомендовал?"];
        const ratingCriteria = ["Сюжет", "Персонажи", "Стиль", "Эмоции", "Оригинальность", "Динамика", "Атмосфера", "Польза", "Финал", "Оформление"];
        const monthIndices = { 'Январь': 0, 'Февраль': 1, 'Март': 2, 'Апрель': 3, 'Май': 4, 'Июнь': 5, 'Июль': 6, 'Август': 7, 'Сентябрь': 8, 'Октябрь': 9, 'Ноябрь': 10, 'Декабрь': 11 };

        let books = [];
        let currentEditingId = null;
        let selectedCoverBase64 = null;

        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.remove('hidden');

            const addBtn = document.getElementById('btn-add-global');
            const navTabs = document.getElementById('nav-tabs');
            const searchBar = document.getElementById('search-bar-container');

            if (tabId === 'add' || tabId === 'view') {
                navTabs.classList.add('hidden');
                searchBar.classList.add('hidden');
                addBtn.innerText = "Назад";
                addBtn.onclick = () => window.switchTab('all');
            } else {
                navTabs.classList.remove('hidden');
                searchBar.classList.toggle('hidden', tabId !== 'all' && tabId !== 'rating');
                addBtn.innerText = "+ Книга";
                addBtn.onclick = () => window.openAddForm();
                document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.tab === tabId));
                window.renderCurrentTab();
            }
            window.scrollTo(0,0);
        };

        window.renderCurrentTab = () => {
            const activeTab = document.querySelector('.nav-item.active')?.dataset.tab || 'all';
            const query = document.getElementById('shelf-search').value.toLowerCase();
            const filtered = books.filter(b => b.title.toLowerCase().includes(query) || b.author.toLowerCase().includes(query));

            if (activeTab === 'all') renderShelf('shelf-all', filtered);
            else if (activeTab === 'rating') renderRatingTab(filtered);
            else if (activeTab === 'months') renderByMonths(filtered);
            else if (activeTab === 'authors') renderByAuthors(filtered);
            else if (activeTab === 'tags') renderByTags(filtered);
        };

        function getRatingClass(val) {
            const n = parseFloat(val);
            if (n < 5) return 'rating-red';
            if (n < 8) return 'rating-blue';
            return 'rating-green';
        }

        function createCard(b) {
            const div = document.createElement('div');
            div.className = 'book-card';
            div.onclick = () => window.viewBook(b.id);
            div.innerHTML = `
                <div class="rating-badge ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div>
                <div class="book-cover">
                    <img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'">
                    <div class="book-date-badge">${b.month}</div>
                </div>
            `;
            return div;
        }

        function renderShelf(containerId, data) {
            const shelf = document.getElementById(containerId);
            shelf.innerHTML = '';
            if (containerId === 'shelf-all') {
                const add = document.createElement('div');
                add.className = 'book-card';
                add.onclick = () => window.openAddForm();
                add.innerHTML = `<div class="book-cover add-card" style="border: 2px dashed var(--tg-hint); display: flex; align-items: center; justify-content: center; background:transparent"><span style="font-size: 40px; color: var(--tg-hint); font-weight: 300;">+</span></div>`;
                shelf.appendChild(add);
            }
            data.sort((a,b) => b.year !== a.year ? b.year - a.year : monthIndices[b.month] - monthIndices[a.month]).forEach(b => shelf.appendChild(createCard(b)));
        }

        function renderRatingTab(data) {
            const shelf = document.getElementById('shelf-rating');
            shelf.innerHTML = '';
            const sorted = [...data].sort((a,b) => parseFloat(b.rating) - parseFloat(a.rating));
            sorted.forEach(b => {
                const item = document.createElement('div');
                item.className = 'rating-list-item';
                item.onclick = () => window.viewBook(b.id);
                item.innerHTML = `
                    <img class="rating-list-img" src="${b.img}" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                    <div class="rating-list-content">
                        <div class="rl-title">${b.title}</div>
                        <div class="rl-author">${b.author}</div>
                        <div class="rl-meta">${b.genre} • ${b.month} ${b.year}</div>
                        <div class="rl-tags">${(b.tags || []).slice(0,3).map(t => `<span class="rl-tag">#${t}</span>`).join('')}</div>
                    </div>
                    <div class="rl-score-box ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div>
                `;
                shelf.appendChild(item);
            });
        }

        function renderByMonths(data) {
            const shelf = document.getElementById('shelf-months');
            shelf.innerHTML = '';
            const years = [...new Set(data.map(b => b.year))].sort((a,b) => b-a);
            years.forEach(y => {
                const yearBooks = data.filter(b => b.year === y);
                const months = [...new Set(yearBooks.map(b => b.month))].sort((a,b) => monthIndices[b] - monthIndices[a]);
                months.forEach(m => {
                    const group = document.createElement('div');
                    group.innerHTML = `<div class="group-title">${m} ${y}</div>`;
                    const grid = document.createElement('div');
                    grid.className = 'book-shelf';
                    yearBooks.filter(b => b.month === m).forEach(b => grid.appendChild(createCard(b)));
                    group.appendChild(grid);
                    shelf.appendChild(group);
                });
            });
        }

        function renderByAuthors(data) {
            const shelf = document.getElementById('shelf-authors');
            shelf.innerHTML = '';
            const allAuthors = [...new Set(data.flatMap(b => b.author.split(',').map(s => s.trim()).filter(Boolean)))].sort();
            allAuthors.forEach(a => {
                const group = document.createElement('div');
                group.innerHTML = `<div class="group-title">${a}</div>`;
                const grid = document.createElement('div');
                grid.className = 'book-shelf';
                data.filter(b => b.author.split(',').map(s => s.trim()).includes(a)).forEach(b => grid.appendChild(createCard(b)));
                group.appendChild(grid);
                shelf.appendChild(group);
            });
        }

        function renderByTags(data) {
            const shelf = document.getElementById('shelf-tags');
            shelf.innerHTML = '';
            const tags = [...new Set(data.flatMap(b => b.tags || []))].sort();
            tags.forEach(t => {
                const group = document.createElement('div');
                group.innerHTML = `<div class="group-title">${t}</div>`;
                const grid = document.createElement('div');
                grid.className = 'book-shelf';
                data.filter(b => (b.tags || []).includes(t)).forEach(b => grid.appendChild(createCard(b)));
                group.appendChild(grid);
                shelf.appendChild(group);
            });
        }

        window.openAddForm = (bookId = null) => {
            currentEditingId = bookId;
            window.switchTab('add');
            const yearSel = document.getElementById('f-year');
            if (yearSel.options.length === 0) {
                const cur = new Date().getFullYear();
                for(let i=cur+2; i>=2000; i--) yearSel.add(new Option(i, i));
                yearSel.value = cur;
            }
            document.getElementById('f-title').value = '';
            document.getElementById('f-author').value = '';
            document.getElementById('f-genre').value = '';
            document.getElementById('f-tags').value = '';
            document.getElementById('selected-questions').innerHTML = '';
            selectedCoverBase64 = null;
            document.getElementById('cover-preview-container').innerHTML = `<span>+<br>Обложка</span>`;
            const book = bookId ? books.find(b => b.id === bookId) : null;
            document.getElementById('q-cloud').innerHTML = questionsPool.map(q => {
                const active = book && book.answers && book.answers[q];
                return `<div class="q-chip ${active ? 'selected' : ''}" onclick="window.toggleQuestion(this, '${q}')">${q}</div>`;
            }).join('');
            document.getElementById('ratings-list').innerHTML = ratingCriteria.map((c, i) => {
                const val = (book && book.criteria) ? book.criteria[i] : 5;
                return `<div class="rating-row"><div class="rating-info"><span>${c}</span><span id="rv-${i}">${val}</span></div><input type="range" class="rating-slider" min="1" max="10" value="${val}" oninput="document.getElementById('rv-${i}').innerText=this.value"></div>`;
            }).join('');
            if (book) {
                document.getElementById('f-title').value = book.title;
                document.getElementById('f-author').value = book.author;
                document.getElementById('f-genre').value = book.genre;
                document.getElementById('f-tags').value = (book.tags || []).join(', ');
                document.getElementById('f-month').value = book.month;
                document.getElementById('f-year').value = book.year;
                if (book.img) { selectedCoverBase64 = book.img; document.getElementById('cover-preview-container').innerHTML = `<img src="${book.img}">`; }
                if (book.answers) { Object.entries(book.answers).forEach(([q, a]) => addQuestionItem(q, a, !questionsPool.includes(q))); }
            }
        };

        window.toggleQuestion = (el, q) => {
            el.classList.toggle('selected');
            const id = 'q-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, '');
            if (el.classList.contains('selected')) addQuestionItem(q, '', false);
            else document.getElementById(id)?.remove();
        };

        function addQuestionItem(q, val, isCustom) {
            const container = document.getElementById('selected-questions');
            const id = isCustom ? ('custom-' + Date.now() + Math.random()) : ('q-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, ''));
            if (!isCustom && document.getElementById(id)) return;
            const div = document.createElement('div');
            div.className = 'q-item';
            div.id = id;
            div.innerHTML = `<div class="q-header-row">${isCustom ? `<input type="text" class="custom-q-label-input" value="${q}" placeholder="Свой вопрос...">` : `<label>${q}</label>`}<div class="delete-q-btn" onclick="this.closest('.q-item').remove()">${iconTrash}</div></div><textarea placeholder="Ваш ответ...">${val}</textarea>`;
            container.appendChild(div);
        }

        window.addCustomQuestion = () => addQuestionItem('', '', true);

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { selectedCoverBase64 = e.target.result; document.getElementById('cover-preview-container').innerHTML = `<img src="${e.target.result}">`; };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.saveBook = () => {
            const title = document.getElementById('f-title').value.trim();
            if (!title) { Telegram.WebApp.showAlert('Пожалуйста, введите название книги'); return; }
            const criteria = Array.from(document.querySelectorAll('.rating-slider')).map(s => parseInt(s.value));
            const avg = (criteria.reduce((a,b) => a+b, 0) / criteria.length).toFixed(1);
            const answers = {};
            document.querySelectorAll('.q-item').forEach(item => {
                const labelEl = item.querySelector('label') || item.querySelector('.custom-q-label-input');
                const label = labelEl.tagName === 'INPUT' ? labelEl.value.trim() : labelEl.innerText;
                const text = item.querySelector('textarea').value.trim();
                if (label && text) answers[label] = text;
            });
            const authorRaw = document.getElementById('f-author').value.trim() || 'Неизвестный автор';
            const authorNormalized = authorRaw.split(',').map(a => a.trim()).filter(Boolean).join(', ');
            const bookData = { id: currentEditingId || Date.now().toString(), title, author: authorNormalized, genre: document.getElementById('f-genre').value.trim(), month: document.getElementById('f-month').value, year: document.getElementById('f-year').value, rating: avg, img: selectedCoverBase64 || '', tags: document.getElementById('f-tags').value.split(',').map(t => t.trim()).filter(t => t), answers, criteria };
            if (currentEditingId) books = books.map(b => b.id === currentEditingId ? bookData : b);
            else books.unshift(bookData);
            localStorage.setItem('reading_journal_v2', JSON.stringify(books));
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            window.switchTab('all');
        };

        window.viewBook = (id) => {
            const b = books.find(x => x.id === id);
            if (!b) return;
            const container = document.getElementById('note-details');
            let qaHtml = '';
            Object.entries(b.answers || {}).forEach(([q, a]) => { qaHtml += `<div class="note-qa-item"><span class="q">${q}</span><div class="a">${a}</div></div>`; });
            let ratingsHtml = `<div class="view-detailed-ratings"><div class="group-title">Детальный рейтинг</div>`;
            ratingCriteria.forEach((name, i) => { ratingsHtml += `<div class="view-rating-item"><span>${name}</span><span class="rating-badge-score">${b.criteria[i]}</span></div>`; });
            ratingsHtml += '</div>';

            container.innerHTML = `
                <div class="view-header-flex">
                    <div class="view-cover-fixed">
                        <div class="rating-badge ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div>
                        <div class="book-cover">
                            <img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'">
                        </div>
                    </div>
                    <div class="view-info-text">
                        <h1>${b.title}</h1>
                        <h2>${b.author}</h2>
                        <div class="view-genre">${b.genre || ''}</div>
                        <div>
                            <span class="view-month">${b.month}</span>
                            <span class="view-year">${b.year}</span>
                        </div>
                        <div class="view-tags-container">
                            ${(b.tags || []).map(t => `<span class="view-tag">#${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
                <div class="view-actions-side">
                    <button class="btn-base btn-mini-action fill" onclick="window.openAddForm('${b.id}')">${iconEdit}</button>
                    <button class="btn-base btn-mini-action" onclick="window.exportPDF('${b.title}')">${iconPdf}</button>
                    <button class="btn-base btn-mini-action" onclick="window.deleteBook('${b.id}')">${iconTrash}</button>
                </div>
                <div class="note-qa">${qaHtml || '<p style="text-align:center; opacity:0.5">Нет заметок</p>'}</div>
                ${ratingsHtml}
            `;
            window.switchTab('view');
        };

        window.exportPDF = async (name) => {
            const element = document.getElementById('note-details');
            document.body.classList.add('pdf-export-mode');
            const opt = { 
                margin: 10, 
                filename: `Reading_Note_${name.replace(/\s+/g, '_')}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, logging: false }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            try { await html2pdf().set(opt).from(element).save(); } finally { document.body.classList.remove('pdf-export-mode'); }
        };

        window.deleteBook = (id) => {
            Telegram.WebApp.showConfirm("Вы уверены, что хотите удалить этот конспект?", (confirmed) => { if (confirmed) { books = books.filter(b => b.id !== id); localStorage.setItem('reading_journal_v2', JSON.stringify(books)); window.switchTab('all'); } });
        };

        window.onload = () => {
            const saved = localStorage.getItem('reading_journal_v2');
            if (saved) books = JSON.parse(saved);
            window.switchTab('all');
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        };
    </script>
</body>
</html>
