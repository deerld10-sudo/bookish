<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Reading Journal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --tg-bg: #1A1A1C;
            --tg-sec-bg: #2c2c2e;
            --tg-text: #ffffff;
            --tg-hint: #8e8e93;
            --tg-accent: #85BC41; 
            --rating-red: rgba(208, 47, 47, 0.8);
            --rating-blue: rgba(46, 78, 220, 0.8);
            --rating-green: rgba(133, 188, 65, 0.8);
            --card-shadow: 0 4px 12px rgba(0,0,0,0.5);
            --check-blue: #3a96ff;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
        }

        html {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0; padding: 0;
            min-height: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
        }

        /* Navigation */
        .top-nav {
            position: sticky; top: 0;
            background-color: var(--tg-bg); z-index: 100;
            padding: 10px 16px; display: flex; align-items: center; gap: 12px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }

        .nav-items-wrapper { 
            display: flex; gap: 8px; flex: 1; 
            overflow-x: auto; scrollbar-width: none; 
            padding-bottom: 2px;
        }
        .nav-items-wrapper::-webkit-scrollbar { display: none; }
        .nav-items-wrapper.hidden { display: none !important; }

        .nav-item {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500;
            white-space: nowrap; background-color: var(--tg-sec-bg); color: var(--tg-hint);
            transition: all 0.2s ease; cursor: pointer;
        }
        .nav-item.active { background-color: var(--tg-text); color: var(--tg-bg); }

        .btn-add-top { 
            background: none; border: none; cursor: pointer; 
            color: var(--tg-accent); font-size: 14px; font-weight: 600; 
            white-space: nowrap; padding: 4px 8px;
        }

        /* Search Bar */
        .search-container {
            padding: 12px 16px;
            background: var(--tg-bg);
        }
        .search-input {
            width: 100%;
            background: var(--tg-sec-bg);
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--tg-text);
            font-size: 14px;
        }

        /* App padding adjusted to 10px to accommodate new requirements */
        #app { flex: 1; padding: 10px 16px 16px 16px; }
        
        /* Default section padding to maintain 24px distance (10px app + 14px section) */
        .section { padding-top: 14px; animation: fadeIn 0.3s ease-out; } 
        
        /* Overrides for specific sections to have 10px distance from search */
        #tab-months, #tab-authors, #tab-tags { padding-top: 0; }

        .hidden { display: none !important; }

        /* Grid Shelf */
        .book-shelf { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; 
            margin: 0 auto; 
        }
        @media (min-width: 480px) { .book-shelf { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .book-shelf { grid-template-columns: repeat(4, 1fr); } }

        .book-card { position: relative; cursor: pointer; transition: transform 0.2s ease; }
        .book-card:active { transform: scale(0.95); }
        .book-cover { 
            width: 100%; aspect-ratio: 2/3; background-color: var(--tg-sec-bg); 
            border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); 
            position: relative; border: 0.5px solid rgba(255,255,255,0.05);
            z-index: 1;
        }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .book-date-badge { 
            position: absolute; bottom: 8px; left: 8px; font-size: 10px; 
            background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 6px; 
            color: #fff; backdrop-filter: blur(4px); font-weight: 500;
        }
        
        .rating-badge { 
            position: absolute; top: -8px; right: -8px; font-size: 11px; font-weight: 800; 
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: #ffffff; z-index: 10; border: 2px solid var(--tg-bg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .rating-red { background-color: var(--rating-red); }
        .rating-blue { background-color: var(--rating-blue); }
        .rating-green { background-color: var(--rating-green); }

        /* Deferred Card Icons */
        .deferred-actions {
            position: absolute; top: -8px; right: -8px; 
            display: flex; gap: 6px; z-index: 10;
        }
        .deferred-badge {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--tg-bg); box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer; transition: 0.2s;
            background: var(--tg-sec-bg); color: #fff;
        }
        .deferred-badge svg { width: 14px; height: 14px; fill: currentColor; }

        .group-title { 
            font-size: 18px; font-weight: 700; margin: 24px 0 16px 0; 
            display: flex; align-items: baseline; gap: 8px; 
            border-left: 3px solid var(--tg-accent); padding-left: 12px;
        }

        /* Spacing overrides for specific tabs */
        #tab-months .group-title, 
        #tab-authors .group-title, 
        #tab-tags .group-title { 
            margin-bottom: 24px; /* Title to Content: 24px */
        }
        /* Ensure the first header in target sections is exactly 10px from search bar */
        #shelf-months > div:first-child .group-title,
        #shelf-authors > div:first-child .group-title,
        #shelf-tags > div:first-child .group-title {
            margin-top: 0;
        }

        /* Goal Section Styles */
        .goal-container {
            width: 100%;
            margin: 0 auto;
            padding-bottom: 40px;
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .goal-header h2 {
            font-size: 18px; font-weight: 700; margin: 0;
            border-left: 3px solid var(--tg-accent); padding-left: 12px;
        }
        
        .goal-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 30px;
            grid-template-columns: repeat(4, 1fr);
        }
        @media (min-width: 600px) { .goal-grid { grid-template-columns: repeat(8, 1fr); } }
        @media (min-width: 1024px) { .goal-grid { grid-template-columns: repeat(10, 1fr); } }

        .goal-slot {
            aspect-ratio: 2/3;
            background: #252527;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: #38383a;
            position: relative;
        }
        .goal-slot.filled {
            background: var(--tg-sec-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .goal-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .check-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            background: var(--check-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--tg-bg);
            z-index: 5;
            color: #fff;
        }
        .check-badge svg { width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; }

        .goal-footer { margin-top: 24px; text-align: center; }
        .goal-footer-main { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .goal-footer-sub { font-size: 13px; color: var(--tg-hint); }

        /* Modal Settings */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .goal-modal {
            background: var(--tg-sec-bg);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .goal-modal h3 { margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--tg-text); }
        .modal-close-x {
            position: absolute; top: 12px; right: 16px; 
            font-size: 20px; color: var(--tg-hint); cursor: pointer;
        }
        
        .goal-input-box {
            background: var(--tg-bg);
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            height: 44px;
        }
        .goal-input-box input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            width: 40px;
            text-align: center;
            padding: 0;
            appearance: textfield;
            -moz-appearance: textfield;
        }
        .goal-input-box input::-webkit-outer-spin-button,
        .goal-input-box input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .goal-input-box span { color: var(--tg-hint); font-size: 14px; }
        
        .goal-stepper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            padding-left: 8px;
        }
        .goal-stepper-btn {
            background: transparent;
            border: none;
            color: #fff;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 12px;
            opacity: 0.6;
        }
        .goal-stepper-btn:active { opacity: 1; }
        .goal-stepper-btn svg { width: 10px; height: 10px; fill: none; stroke: currentColor; stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; }

        .goal-modal-btns { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .goal-modal-btns.row { flex-direction: row; gap: 12px; }
        .btn-goal-action {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: opacity 0.2s;
        }
        .btn-goal-action:active { opacity: 0.7; }
        .btn-goal-save { background: var(--tg-accent); color: #fff; }
        .btn-goal-cancel { background: var(--tg-bg); color: var(--tg-text); }
        .btn-goal-gray { background: rgba(255,255,255,0.05); color: var(--tg-hint); }

        /* Rating Tab Styles (Restored) */
        .rating-list-container { display: flex; flex-direction: column; gap: 12px; }
        .rating-list-item { 
            display: flex; gap: 16px; background: var(--tg-sec-bg); 
            padding: 12px; border-radius: 16px; cursor: pointer;
            transition: background 0.2s; align-items: center;
        }
        .rating-list-item:active { background: rgba(255,255,255,0.05); }
        .rating-list-img { width: 60px; aspect-ratio: 2/3; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .rating-list-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .rl-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* Increased vertical spacing by 50% (4px -> 6px) */
        .rl-author { font-size: 13px; color: var(--tg-hint); margin-bottom: 6px; }
        .rl-meta { font-size: 11px; color: var(--tg-hint); font-style: italic; }
        .rl-score-box { 
            display: flex; align-items: center; justify-content: center; 
            width: 36px; height: 36px; border-radius: 50%; color: #fff; font-weight: 800; font-size: 12px;
            flex-shrink: 0;
        }

        /* Form Styles */
        .add-form { display: flex; flex-direction: column; gap: 24px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        /* Class for main section spacing (2x original gap) */
        .form-section { margin-bottom: 48px; }
        
        .form-header { display: flex; gap: 20px; }
        .cover-upload { 
            width: 110px; flex-shrink: 0; aspect-ratio: 2/3; border-radius: 10px; 
            border: 2px dashed var(--tg-hint); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; padding: 10px; font-size: 11px; color: var(--tg-hint); 
            cursor: pointer; background: rgba(255,255,255,0.03);
        }
        .cover-upload img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        
        .form-inputs { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .form-inputs input { 
            background: var(--tg-sec-bg); border: none; border-radius: 10px; 
            padding: 12px; color: var(--tg-text); font-size: 14px; 
        }
        .form-inputs input::placeholder { color: var(--tg-hint); }
        
        .form-date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .custom-select-wrapper { position: relative; background: var(--tg-sec-bg); border-radius: 10px; }
        .custom-select-wrapper select { 
            width: 100%; background: transparent; border: none; padding: 12px; 
            color: var(--tg-text); font-size: 14px; appearance: none;
        }
        .select-icon { 
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
            pointer-events: none; width: 14px; height: 14px; opacity: 0.5;
        }

        .questions-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .q-chip { 
            padding: 8px 14px; background: var(--tg-sec-bg); border-radius: 18px; 
            font-size: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .q-chip.selected { background: var(--tg-accent); color: #fff; font-weight: 500; }

        .q-item { 
            background: var(--tg-sec-bg); border-radius: 14px; padding: 16px; 
            margin-bottom: 16px; position: relative; 
        }
        .q-item .q-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .q-item label, .custom-q-label-input { 
            display: block; font-size: 13px; font-weight: 700; 
            color: var(--tg-hint); font-style: italic;
        }
        .custom-q-label-input { 
            background: transparent; border: none; width: calc(100% - 30px); 
            padding-bottom: 4px;
        }
        .q-item textarea { 
            width: 100%; background: transparent; border: none; 
            border-left: 2px solid var(--tg-accent);
            padding: 4px 0 4px 12px; color: var(--tg-text); 
            font-size: 15px; resize: none; min-height: 80px; line-height: 1.5; font-weight: 700;
        }
        .delete-q-btn { 
            color: var(--tg-accent); width: 16px; height: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .delete-q-btn svg { width: 100%; height: 100%; fill: currentColor; }

        .rating-row { margin-bottom: 16px; }
        .rating-info { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: var(--tg-hint); }
        .rating-slider { 
            width: 100%; -webkit-appearance: none; height: 6px; 
            background: var(--tg-sec-bg); border-radius: 3px; 
        }
        .rating-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 22px; height: 22px; 
            background: var(--tg-accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Media Section Edit Mode */
        .media-edit-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;
        }
        .media-edit-item {
            aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; background: var(--tg-bg);
        }
        .media-edit-item img { width: 100%; height: 100%; object-fit: cover; }
        .media-del-btn {
            position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.6); border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
        }

        /* View Media Block - Updated Gaps to 10px */
        .view-media-header {
            display: flex; justify-content: space-between; align-items: center; margin: 32px 0 16px 0;
        }
        .media-mode-switch { display: flex; gap: 8px; }
        
        .media-display-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px;
        }
        .media-display-carousel {
            display: flex; gap: 10px; overflow-x: auto; scroll-snap-type: x mandatory;
            padding-bottom: 8px; scrollbar-width: none;
        }
        .media-display-carousel::-webkit-scrollbar { display: none; }
        
        .media-item {
            aspect-ratio: 1; border-radius: 12px; overflow: hidden; background: var(--tg-sec-bg);
            cursor: pointer; flex-shrink: 0;
        }
        .media-display-carousel .media-item { width: 150px; scroll-snap-align: start; }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Lightbox */
        .lightbox {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        .lightbox-close {
            position: absolute; top: 20px; right: 20px; width: 44px; height: 44px;
            background: rgba(255,255,255,0.1); border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .btn-base {
            padding: 10px; border-radius: 12px; font-size: 13px; font-weight: 700; 
            cursor: pointer; text-align: center; border: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .save-btn { background: var(--tg-accent); color: #fff; width: 100%; margin-top: 20px; padding: 14px; }
        
        .btn-mini-action { background: var(--tg-sec-bg); color: var(--tg-text); border-radius: 10px; width: 44px; height: 44px; padding: 0; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-mini-action.fill { background: var(--tg-accent); color: #fff; }
        .btn-mini-action svg { width: 20px; height: 20px; fill: currentColor; }

        .view-note { max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        .view-header-flex { 
            display: flex; gap: 24px; margin-bottom: 24px; 
            padding-bottom: 24px; border-bottom: 0.5px solid rgba(255, 255, 255, 0.1); 
        }
        .view-cover-fixed { width: 140px; flex-shrink: 0; position: relative; }
        .view-info-text h1 { font-size: 22px; margin: 0 0 8px 0; }
        .view-info-text h2 { font-size: 16px; color: var(--tg-text); margin: 0 0 4px 0; font-weight: 500; }
        .view-genre { color: var(--tg-hint) !important; font-weight: 400 !important; font-size: 16px; margin-bottom: 4px; }
        .view-month { font-size: 16px; color: var(--tg-hint); display: inline-block; }
        .view-year { font-size: 12px; color: var(--tg-hint); font-style: italic; display: inline-block; margin-left: 4px; }
        .view-tag { font-size: 11px; background: var(--tg-sec-bg); padding: 4px 8px; border-radius: 6px; color: var(--tg-hint); }
        .view-tags-container { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }

        .view-actions-side { display: flex; gap: 12px; margin-bottom: 32px; align-items: center; }

        .note-qa-item { margin-bottom: 24px; }
        .note-qa-item .q { 
            font-size: 13px; color: var(--tg-hint); font-style: italic; 
            display: block; margin-bottom: 6px; 
        }
        .note-qa-item .a { 
            font-size: 16px; line-height: 1.5; white-space: pre-wrap; color: #fff; font-weight: 700;
            border-left: 2px solid var(--tg-accent); padding-left: 12px;
        }

        .view-detailed-ratings { margin-top: 40px; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 24px; }
        .view-rating-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 0.5px solid rgba(255,255,255,0.05); }
        .view-rating-item:last-child { border-bottom: none; }
        .rating-badge-score { font-weight: 700; color: var(--tg-accent); }

        @media (max-width: 600px) {
            .view-header-flex { flex-direction: column; align-items: center; text-align: center; }
            .view-actions-side { justify-content: center; }
            .view-tags-container { justify-content: center; }
        }

        .pdf-export-mode { background: #fff !important; color: #000 !important; }
        .pdf-export-mode #note-details { padding: 40px !important; color: #000 !important; }
        .pdf-export-mode .view-actions-side { display: none !important; }
        .pdf-export-mode .note-qa-item { border-bottom: 1px solid #eee; padding-bottom: 12px; }
        .pdf-export-mode .q, .pdf-export-mode .a, .pdf-export-mode .view-rating-item { font-size: 14px !important; }
        .pdf-export-mode .q { color: #888 !important; }
        .pdf-export-mode .a { color: #000 !important; border-left-color: #5a8c20 !important; }
        .pdf-export-mode .view-info-text h1, .pdf-export-mode .view-info-text h2 { color: #000 !important; }
        .pdf-export-mode .view-genre { color: #999 !important; }
        .pdf-export-mode .view-tag { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #eee; }
        .pdf-export-mode .view-detailed-ratings { background: #f5f5f5 !important; border: 1px solid #eee; color: #000 !important; padding: 20px !important; border-radius: 12px !important; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="top-nav" id="main-nav">
            <div class="nav-items-wrapper" id="nav-tabs">
                <div class="nav-item active" data-tab="all" onclick="window.switchTab('all')">Все</div>
                <div class="nav-item" data-tab="rating" onclick="window.switchTab('rating')">Рейтинг</div>
                <div class="nav-item" data-tab="months" onclick="window.switchTab('months')">Месяцы</div>
                <div class="nav-item" data-tab="authors" onclick="window.switchTab('authors')">Авторы</div>
                <div class="nav-item" data-tab="tags" onclick="window.switchTab('tags')">Хэштеги</div>
                <div class="nav-item" data-tab="goal" onclick="window.switchTab('goal')">Цель</div>
                <div class="nav-item" data-tab="deferred" onclick="window.switchTab('deferred')">Отложенные</div>
            </div>
            <button class="btn-add-top" id="btn-add-global" onclick="window.openAddForm()">+ Книга</button>
        </div>

        <div class="search-container" id="search-bar-container">
            <input type="text" class="search-input" id="shelf-search" placeholder="Поиск по названию или автору..." oninput="window.renderCurrentTab()">
        </div>

        <div id="app">
            <div id="tab-all" class="section">
                <div class="book-shelf" id="shelf-all"></div>
            </div>
            <div id="tab-rating" class="section hidden">
                <div class="rating-list-container" id="shelf-rating"></div>
            </div>
            <div id="tab-months" class="section hidden">
                <div id="shelf-months"></div>
            </div>
            <div id="tab-authors" class="section hidden">
                <div id="shelf-authors"></div>
            </div>
            <div id="tab-tags" class="section hidden">
                <div id="shelf-tags"></div>
            </div>

            <div id="tab-goal" class="section hidden">
                <div class="goal-container">
                    <div class="goal-header">
                        <h2>Книг за этот год</h2>
                        <button class="btn-mini-action" onclick="window.openGoalModal()">
                            <svg id="fi_2099058" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m272.066 512h-32.133c-25.989 0-47.134-21.144-47.134-47.133v-10.871c-11.049-3.53-21.784-7.986-32.097-13.323l-7.704 7.704c-18.659 18.682-48.548 18.134-66.665-.007l-22.711-22.71c-18.149-18.129-18.671-48.008.006-66.665l7.698-7.698c-5.337-10.313-9.792-21.046-13.323-32.097h-10.87c-25.988 0-47.133-21.144-47.133-47.133v-32.134c0-25.989 21.145-47.133 47.134-47.133h10.87c3.531-11.05 7.986-21.784 13.323-32.097l-7.704-7.703c-18.666-18.646-18.151-48.528.006-66.665l22.713-22.712c18.159-18.184 48.041-18.638 66.664.006l7.697 7.697c10.313-5.336 21.048-9.792 32.097-13.323v-10.87c0-25.989 21.144-47.133 47.134-47.133h32.133c25.989 0 47.133 21.144 47.133 47.133v10.871c11.049 3.53 21.784 7.986 32.097 13.323l7.704-7.704c18.659-18.682 48.548-18.134 66.665.007l22.711 22.71c18.149 18.129 18.671 48.008-.006 66.665l-7.698 7.698c5.337 10.313 9.792 21.046 13.323 32.097h10.87c25.989 0 47.134 21.144 47.134 47.133v32.134c0 25.989-21.145 47.133-47.134 47.133h-10.87c-3.531 11.05-7.986 21.784-13.323 32.097l7.704 7.704c18.666 18.646 18.151 48.528-.006 66.665l-22.713 22.712c-18.159 18.184-48.041 18.638-66.664-.006l-7.697-7.697c-10.313 5.336-21.048-9.792-32.097 13.323v10.871c0 25.987-21.144 47.131-47.134 47.131zm-106.349-102.83c14.327 8.473 29.747 14.874 45.831 19.025 6.624 1.709 11.252 7.683 11.252 14.524v22.148c0 9.447 7.687 17.133 17.134 17.133h32.133c9.447 0 17.134-7.686 17.134-17.133v-22.148c0-6.841 4.628-12.815 11.252-14.524 16.084-4.151 31.504-10.552 45.831-19.025 5.895-3.486 13.4-2.538 18.243 2.305l15.688 15.689c6.764 6.772 17.626 6.615 24.224.007l22.727-22.726c6.582-6.574 6.802-17.438.006-24.225l-15.695-15.695c-4.842-4.842-5.79-12.348-2.305-18.242 8.473-14.326 14.873-29.746 19.024-45.831 1.71-6.624 7.684-11.251 14.524-11.251h22.147c9.447 0 17.134-7.686 17.134-17.133v-32.134c0-9.447-7.687-17.133-17.134-17.133h-22.147c-6.841 0-12.814-4.628-14.524-11.251-4.151-16.085-10.552-31.505-19.024-45.831-3.485-5.894-2.537-13.4 2.305-18.242l15.689-15.689c6.782-6.774 6.605-17.634.006-24.225l-22.725-22.725c-6.587-6.596-17.451-6.789-24.225-.006l-15.694 15.695c-4.842 4.843-12.35 5.791-18.243 2.305-14.327-8.473-29.747-14.874-45.831-19.025-6.624-1.709-11.252-7.683-11.252-14.524v-22.15c0-9.447-7.687-17.133-17.134-17.133h-32.133c-9.447 0-17.134 7.686-17.134 17.133v22.148c0 6.841-4.628 12.815-11.252 14.524-16.084 4.151-31.504 10.552-45.831 19.025-5.896 3.485-13.401 2.537-18.243-2.305l-15.688-15.689c-6.764-6.772-17.627-6.615-24.224-.007l-22.727 22.726c-6.582 6.574-6.802 17.437-.006 24.225l15.695 15.695c4.842 4.842 5.79 12.348 2.305 18.242-8.473 14.326-14.873 29.746-19.024 45.831-1.71 6.624-7.684 11.251-14.524 11.251h-22.148c-9.447.001-17.134 7.687-17.134 17.134v32.134c0 9.447 7.687 17.133 17.134 17.133h22.147c6.841 0 12.814 4.628 14.524 11.251 4.151 16.085 10.552 31.505 19.024 45.831 3.485 5.894 2.537 13.4-2.305 18.242l-15.689 15.689c-6.782 6.774-6.605 17.634-.006 24.225l22.725 22.725c6.587 6.596 17.451 6.789 24.225.006l15.694-15.695c3.568-3.567 10.991-6.594 18.244-2.304z"></path><path d="m256 367.4c-61.427 0-111.4-49.974-111.4-111.4s49.973-111.4 111.4-111.4 111.4 49.974 111.4 111.4-49.973 111.4-111.4 111.4zm0-192.8c-44.885 0-81.4 36.516-81.4 81.4s36.516 81.4 81.4 81.4 81.4-36.516 81.4-81.4-36.515-81.4-81.4-81.4z"></path></svg>
                        </button>
                    </div>
                    <div class="goal-grid" id="goal-grid-container"></div>
                    <div class="goal-footer" id="goal-footer-info"></div>
                </div>
            </div>

            <div id="tab-deferred" class="section hidden">
                <div class="book-shelf" id="shelf-deferred"></div>
            </div>

            <div id="tab-add" class="section hidden">
                <div class="add-form">
                    <div class="form-header">
                        <input type="file" id="cover-input" hidden accept="image/*" onchange="window.previewImage(this)">
                        <div class="cover-upload" onclick="document.getElementById('cover-input').click()" id="cover-preview-container">
                            <span>+<br>Обложка</span>
                        </div>
                        <div class="form-inputs">
                            <input type="text" id="f-title" placeholder="Название книги">
                            <input type="text" id="f-author" placeholder="Автор (через запятую)">
                            <input type="text" id="f-genre" placeholder="Жанр">
                            <input type="text" id="f-tags" placeholder="Хэштеги (через запятую)">
                            <div class="form-date-row" id="note-date-row">
                                <div class="custom-select-wrapper">
                                    <select id="f-month">
                                        <option>Январь</option><option>Февраль</option><option>Март</option>
                                        <option>Апрель</option><option>Май</option><option>Июнь</option>
                                        <option>Июль</option><option>Август</option><option>Сентябрь</option>
                                        <option>Октябрь</option><option>Ноябрь</option><option>Декабрь</option>
                                    </select>
                                    <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </div>
                                <div class="custom-select-wrapper">
                                    <select id="f-year"></select>
                                    <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </div>
                            </div>
                            <input type="text" id="f-source" placeholder="Ссылка на источник" class="hidden">
                        </div>
                    </div>
                    
                    <div id="note-only-fields">
                        <div class="form-section">
                            <div class="group-title">Заметки и мысли</div>
                            <div class="questions-cloud" id="q-cloud"></div>
                            <div id="selected-questions"></div>
                            <button class="btn-base btn-mini-action" style="width:100%; border-radius:12px; height:auto; padding:12px;" onclick="window.addCustomQuestion()">+ Свой вопрос</button>
                        </div>

                        <div class="form-section">
                            <div class="group-title">Медиа</div>
                            <input type="file" id="media-input" hidden accept="image/*" multiple onchange="window.handleMediaUpload(this)">
                            <button class="btn-base btn-mini-action" style="width:100%; border-radius:12px; height:auto; padding:12px;" onclick="document.getElementById('media-input').click()">Добавить фотографии</button>
                            <div class="media-edit-grid" id="media-edit-container"></div>
                        </div>

                        <div class="form-section">
                            <div class="group-title">Рейтинг</div>
                            <div id="ratings-list"></div>
                        </div>
                    </div>

                    <button class="btn-base save-btn" id="btn-save-main" onclick="window.saveBook()">СОХРАНИТЬ</button>
                </div>
            </div>

            <div id="tab-view" class="section hidden">
                <div id="note-details" class="view-note"></div>
            </div>
        </div>

        <div id="goal-modal-overlay" class="modal-overlay hidden" onclick="window.closeGoalModal()">
            <div class="goal-modal" onclick="event.stopPropagation()">
                <div class="modal-close-x" onclick="window.closeGoalModal()">✕</div>
                <h3 id="modal-title">Годовая цель по чтению</h3>
                <div id="modal-content">
                    <div class="goal-input-box">
                        <input type="number" id="goal-input-value" value="20" min="1">
                        <span>книг в год</span>
                        <div class="goal-stepper">
                            <button class="goal-stepper-btn" onclick="document.getElementById('goal-input-value').stepUp()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </button>
                            <button class="goal-stepper-btn" onclick="document.getElementById('goal-input-value').stepDown()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="goal-modal-btns row" id="modal-btns">
                    <button class="btn-goal-action btn-goal-cancel" onclick="window.closeGoalModal()">Отменить</button>
                    <button class="btn-goal-action btn-goal-save" onclick="window.saveGoalSettings()">OK</button>
                </div>
            </div>
        </div>
        
        <!-- Lightbox -->
        <div id="lightbox" class="lightbox hidden" onclick="this.classList.add('hidden')">
            <div class="lightbox-close">✕</div>
            <img id="lightbox-img" src="" onclick="event.stopPropagation()">
        </div>
    </div>

    <script>
        const iconEdit = `<svg viewBox="0 0 512 511" xmlns="http://www.w3.org/2000/svg"><path d="m405.332031 256.484375c-11.796875 0-21.332031 9.558594-21.332031 21.332031v170.667969c0 11.753906-9.558594 21.332031-21.332031 21.332031h-298.667969c-11.777344 0-21.332031-9.578125-21.332031-21.332031v-298.667969c0-11.753906 9.554687-21.332031 21.332031-21.332031h170.667969c11.796875 0 21.332031-9.558594 21.332031-21.332031 0-11.777344-9.535156-21.335938-21.332031-21.335938h-170.667969c-35.285156 0-64 28.714844-64 64v298.667969c0 35.285156 28.714844 64 64 64h298.667969c35.285156 0 64-28.714844 64-64v-170.667969c0-11.796875-9.539063-21.332031-21.335938-21.332031zm0 0"></path><path d="m200.019531 237.050781c-1.492187 1.492188-2.496093 3.390625-2.921875 5.4375l-15.082031 75.4375c-.703125 3.496094.40625 7.101563 2.921875 9.640625 2.027344 2.027344 4.757812 3.113282 7.554688 3.113282.679687 0 1.386718-.0625 2.089843-.210938l75.414063-15.082031c2.089844-.429688 3.988281-1.429688 5.460937-2.925781l168.789063-168.789063-75.414063-75.410156zm0 0"></path><path d="m496.382812 16.101562c-20.796874-20.800781-54.632812-20.800781-75.414062 0l-29.523438 29.523438 75.414063 75.414062 29.523437-29.527343c10.070313-10.046875 15.617188-23.445313 15.617188-37.695313s-5.546875-27.648437-15.617188-37.714844zm0 0"></path></svg>`;
        const iconPdf = `<svg enable-background="new 0 0 515.283 515.283" viewBox="0 0 515.283 515.283" xmlns="http://www.w3.org/2000/svg"><path d="m400.775 515.283h-286.268c-30.584 0-59.339-11.911-80.968-33.54-21.628-21.626-33.539-50.382-33.539-80.968v-28.628c0-15.811 12.816-28.628 28.627-28.628s28.627 12.817 28.627 28.628v28.628c0 15.293 5.956 29.67 16.768 40.483 10.815 10.814 25.192 16.771 40.485 16.771h286.268c15.292 0 29.669-5.957 40.483-16.771 10.814-10.815 16.771-25.192 16.771-40.483v-28.628c0-15.811 12.816-28.628 28.626-28.628s28.628 12.817 28.628 28.628v28.628c0 30.584-11.911 59.338-33.54 80.968-21.629 21.629-50.384 33.54-80.968 33.54zm-143.134-114.509c-3.96 0-7.73-.804-11.16-2.257-3.2-1.352-6.207-3.316-8.838-5.885-.001-.001-.001-.002-.002-.002-.019-.018-.038-.037-.057-.056-.005-.004-.011-.011-.016-.016-.016-.014-.03-.029-.045-.044-.01-.01-.019-.018-.029-.029-.01-.01-.023-.023-.032-.031-.02-.02-.042-.042-.062-.062l-114.508-114.509c-11.179-11.179-11.179-29.305 0-40.485 11.179-11.179 29.306-11.18 40.485 0l65.638 65.638v-274.409c-.001-15.811 12.815-28.627 28.626-28.627s28.628 12.816 28.628 28.627v274.408l65.637-65.637c11.178-11.179 29.307-11.179 40.485 0 11.179 11.179 11.179 29.306 0 40.485l-114.508 114.507c-.02.02-.042.042-.062.062-.011.01-.023.023-.032.031-.01.011-.019.019-.029.029-.014.016-.03.03-.044.044-.005.005-.012.012-.017.016-.018.019-.037.038-.056.056-.001 0-.001.001-.002.002-.315.307-.634.605-.96.895-2.397 2.138-5.067 3.805-7.89 4.995-.01.004-.018.008-.028.012-.011.004-.02.01-.031.013-3.412 1.437-7.158 2.229-11.091 2.229z" fill="currentColor"></path></svg>`;
        const iconTrash = `<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><g><path d="M62.205,150l26.569,320.735C90.678,493.865,110.38,512,133.598,512h244.805c23.218,0,42.92-18.135,44.824-41.265 L449.795,150H62.205z M180.986,452c-7.852,0-14.458-6.108-14.956-14.063l-15-242c-0.513-8.276,5.771-15.395,14.033-15.908 c8.569-0.601,15.381,5.757,15.908,14.033l15,242C196.502,444.632,189.721,452,180.986,452z M271,437c0,8.291-6.709,15-15,15 c-8.291,0-15-6.709-15-15V195c0-8.291,6.709-15,15-15s15,6.709,15,15V437z M360.97,195.938l-15,242 c-0.493,7.874-7.056,14.436-15.908,14.033c-8.262-0.513-14.546-7.632-14.033-15.908l15-242 c0.513-8.276,7.764-14.297,15.908-14.033C355.199,180.543,361.483,187.662,360.97,195.938z"></path></g><g><path d="M451,60h-90V45c0-24.814-20.186-45-45-45H196c-24.814,0-45,20.186-45,45v15H61c-16.569,0-30,13.431-30,30 c0,16.567,13.431,30,30,30c137.966,0,252.039,0,390,0c16.569,0,30-13.433,30-30C481,73.431,467.569,60,451,60z M331,60H181V45 c0-8.276,6.724-15,15-15h120c8.276,0,15,6.724,15,15V60z"></path></g></svg>`;
        const iconCheck = `<svg viewBox="0 0 134 134" xmlns="http://www.w3.org/2000/svg" id="fi_8385833"><path d="m17.571 70.766 32.913 32.913c2.034 2.034 5.332 2.034 7.366 0l62.079-62.079c2.032-2.033 2.032-5.334 0-7.366-2.033-2.033-5.333-2.033-7.366 0l-58.396 58.396s-29.23-29.23-29.23-29.23c-2.033-2.032-5.333-2.032-7.366 0-2.032 2.033-2.032 5.334 0 7.366z" fill="currentColor"></path></svg>`;
        const iconLink = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 32 32"><path d="M2,31H1.962A1,1,0,0,1,1,30.1C.967,29.74.128,21.118,5.433,15.226,8.375,11.957,12.6,10.208,18,10.018V6a1,1,0,0,1,1.673-.74l11,10a1,1,0,0,1,0,1.48l-11,10A1,1,0,0,1,18,26V21.907c-3.116-.227-13.453-.322-15.016,8.272A1,1,0,0,1,2,31ZM20,8.261V11a1,1,0,0,1-1,1c-5.29,0-9.354,1.535-12.081,4.564a16.165,16.165,0,0,0-3.678,8.243c4.975-6.16,15.759-4.818,15.891-4.8A1,1,0,0,1,20,21v2.739L28.513,16Z"></path></svg>`;
        
        /* Updated Grid & Carousel Icons */
        const iconGrid = `<svg id="fi_10437031" enable-background="new 0 0 100 100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><g><path d="m89.5 83.333h-79c-5.79 0-10.5-4.71-10.5-10.5v-45.666c0-5.79 4.71-10.5 10.5-10.5h79c5.79 0 10.5 4.71 10.5 10.5v45.667c0 5.789-4.71 10.499-10.5 10.499zm-79-61.666c-3.033 0-5.5 2.467-5.5 5.5v45.667c0 3.032 2.467 5.5 5.5 5.5h79c3.032 0 5.5-2.468 5.5-5.5v-45.667c0-3.033-2.468-5.5-5.5-5.5z"></path><g><path d="m26.333 64.333h-10.333c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5h10.333c1.381 0 2.5 1.119 2.5 2.5s-1.119 2.5-2.5 2.5z"></path><path d="m45.556 64.333h-10.334c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5h10.333c1.381 0 2.5 1.119 2.5 2.5s-1.118 2.5-2.499 2.5z"></path><path d="m64.777 64.333h-10.333c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5h10.333c1.381 0 2.5 1.119 2.5 2.5s-1.119 2.5-2.5 2.5z"></path><path d="m84 64.333h-10.333c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5h10.333c1.381 0 2.5 1.119 2.5 2.5s-1.119 2.5-2.5 2.5z"></path></g></g></svg>`;
        const iconCarousel = `<svg fill="currentColor" height="512" viewBox="0 0 24 24" width="512" xmlns="http://www.w3.org/2000/svg" id="fi_10387094"><g><path d="m13 22.75h-2c-3.3 0-5.29-.66-5.66-4.01-.06-.45-.09-.99-.09-1.74v-10c0-.75.03-1.29.1-1.77.36-3.32 2.35-3.98 5.65-3.98h2c3.3 0 5.29.66 5.66 4.01.06.45.09.99.09 1.74v10c0 .75-.03 1.29-.1 1.77-.36 3.32-2.35 3.98-5.65 3.98zm-2-20c-3.31 0-3.94.67-4.16 2.67-.06.43-.09.9-.09 1.58v10c0 .68.03 1.15.08 1.55.22 2.03.86 2.7 4.17 2.7h2c3.31 0 3.94-.67 4.16-2.67.06-.42.09-.9.09-1.58v-10c0-.67-.03-1.15-.08-1.55-.22-2.03-.86-2.7-4.17-2.7z"></path><path d="m5.67 19.4201h-.34c-3.09 0-4.08-.99-4.08-4.09v-6.66002c0-3.1.99-4.09 4.08-4.09h.34c.17 0 .31 0 .47.01.21.01.4.11.53.28s.19.37.16.58c-.05.4-.08.87-.08 1.55v10.00002c0 .68.03 1.15.08 1.55.03.21-.03.42-.16.58s-.32.26-.53.28c-.16.01-.3.01-.47.01zm-.4-13.34002c-2.19.01-2.52.36-2.52 2.59v6.66002c0 2.23.33 2.58 2.52 2.59-.01-.27-.02-.57-.02-.92v-10.00002c0-.35.01-.65.02-.92z"></path><path d="m18.6697 19.4201h-.34c-.17 0-.31 0-.47-.01-.21-.01-.4-.11-.53-.28-.13-.16-.19-.37-.16-.58.06-.4.08-.88.08-1.55v-10.00002c0-.67-.03-1.15-.08-1.55-.03-.21.03-.42.16-.58s.32-.26.53-.28c.16-.01.3-.01.47-.01h.34c3.09 0 4.08.99 4.08 4.09v6.66002c0 3.1-.99 4.09-4.08 4.09zm.06-13.34002c.01.27.02.57.02.92v10.00002c0 .35-.01.65-.02.92 2.19-.01 2.52-.36 2.52-2.59v-6.66002c0-2.23-.33-2.58-2.52-2.59z"></path></g></svg>`;

        const questionsPool = ["О чём эта книга в целом?", "Какие темы и идеи ключевые?", "Что показалось самым сильным?", "Главные персонажи и их роль?", "Какие сцены запомнились?", "Какие эмоции книга вызвала?", "Что вызвало несогласие?", "Какую мысль я уношу с собой?", "Кому бы я порекомендовал?"];
        const ratingCriteria = ["Сюжет и интрига", "Персонажи и их развитие", "Стиль и язык", "Эмоциональное воздействие", "Оригинальность", "Темп и динамика", "Атмосфера и мир", "Польза и познавательность", "Перечитываемость", "Концовка"];
        const monthIndices = { 'Январь': 0, 'Февраль': 1, 'Март': 2, 'Апрель': 3, 'Май': 4, 'Июнь': 5, 'Июль': 6, 'Август': 7, 'Сентябрь': 8, 'Октябрь': 9, 'Ноябрь': 10, 'Декабрь': 11 };

        let books = [];
        let deferredBooks = [];
        let currentEditingId = null;
        let isDeferredMode = false;
        let selectedCoverBase64 = null;
        let currentYearGoal = 20;
        let currentMediaFiles = [];

        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.remove('hidden');

            const addBtn = document.getElementById('btn-add-global');
            const navTabs = document.getElementById('nav-tabs');
            const searchBar = document.getElementById('search-bar-container');

            if (tabId === 'add' || tabId === 'view') {
                navTabs.classList.add('hidden');
                searchBar.classList.add('hidden');
                addBtn.innerText = "Назад";
                addBtn.onclick = () => window.switchTab(isDeferredMode ? 'deferred' : 'all');
            } else {
                navTabs.classList.remove('hidden');
                searchBar.classList.toggle('hidden', tabId === 'goal' || tabId === 'deferred');
                addBtn.innerText = "+ Книга";
                addBtn.onclick = () => window.openAddForm();
                document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.tab === tabId));
                window.renderCurrentTab();
            }
            window.scrollTo(0,0);
        };

        window.renderCurrentTab = () => {
            const activeTab = document.querySelector('.nav-item.active')?.dataset.tab || 'all';
            const query = document.getElementById('shelf-search').value.toLowerCase();
            if (activeTab === 'deferred') { renderDeferredShelf(); return; }
            const filtered = books.filter(b => b.title.toLowerCase().includes(query) || b.author.toLowerCase().includes(query));
            if (activeTab === 'all') renderShelf('shelf-all', filtered);
            else if (activeTab === 'rating') renderRatingTab(filtered);
            else if (activeTab === 'months') renderByMonths(filtered);
            else if (activeTab === 'authors') renderByAuthors(filtered);
            else if (activeTab === 'tags') renderByTags(filtered);
            else if (activeTab === 'goal') renderGoalTab();
        };

        function getRatingClass(val) {
            const n = parseFloat(val);
            if (n < 5) return 'rating-red';
            if (n < 8) return 'rating-blue';
            return 'rating-green';
        }

        function createCard(b) {
            const div = document.createElement('div');
            div.className = 'book-card';
            div.onclick = () => window.viewBook(b.id);
            div.innerHTML = `<div class="rating-badge ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div><div class="book-cover"><img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'"><div class="book-date-badge">${b.month}</div></div>`;
            return div;
        }

        function createDeferredCard(b) {
            const div = document.createElement('div');
            div.className = 'book-card';
            div.onclick = (e) => { if (!e.target.closest('.deferred-badge')) window.viewDeferredBook(b.id); };
            div.innerHTML = `<div class="deferred-actions"><div class="deferred-badge" onclick="window.openSource('${b.sourceLink}')">${iconLink}</div><div class="deferred-badge" onclick="window.showDeferredMarkModal('${b.id}')">${iconCheck}</div></div><div class="book-cover"><img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'"></div>`;
            return div;
        }

        function renderShelf(containerId, data) {
            const shelf = document.getElementById(containerId);
            shelf.innerHTML = '';
            if (containerId === 'shelf-all') {
                const add = document.createElement('div');
                add.className = 'book-card';
                add.onclick = () => window.openAddForm();
                add.innerHTML = `<div class="book-cover add-card" style="border: 2px dashed var(--tg-hint); display: flex; align-items: center; justify-content: center; background:transparent"><span style="font-size: 40px; color: var(--tg-hint); font-weight: 300;">+</span></div>`;
                shelf.appendChild(add);
            }
            data.sort((a,b) => b.year !== a.year ? b.year - a.year : monthIndices[b.month] - monthIndices[a.month]).forEach(b => shelf.appendChild(createCard(b)));
        }

        function renderDeferredShelf() {
            const shelf = document.getElementById('shelf-deferred');
            shelf.innerHTML = '';
            const add = document.createElement('div');
            add.className = 'book-card';
            add.onclick = () => window.openAddDeferredForm();
            add.innerHTML = `<div class="book-cover add-card" style="border: 2px dashed var(--tg-hint); display: flex; align-items: center; justify-content: center; background:transparent"><span style="font-size: 40px; color: var(--tg-hint); font-weight: 300;">+</span></div>`;
            shelf.appendChild(add);
            deferredBooks.forEach(b => shelf.appendChild(createDeferredCard(b)));
        }

        function renderRatingTab(data) {
            const shelf = document.getElementById('shelf-rating');
            shelf.innerHTML = '';
            const sorted = [...data].sort((a,b) => parseFloat(b.rating) - parseFloat(a.rating));
            sorted.forEach(b => {
                const item = document.createElement('div');
                item.className = 'rating-list-item';
                item.onclick = () => window.viewBook(b.id);
                item.innerHTML = `<img class="rating-list-img" src="${b.img}" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"><div class="rating-list-content"><div class="rl-title">${b.title}</div><div class="rl-author">${b.author}</div><div class="rl-meta">${b.genre} • ${b.month} ${b.year}</div></div><div class="rl-score-box ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div>`;
                shelf.appendChild(item);
            });
        }

        function renderByMonths(data) {
            const shelf = document.getElementById('shelf-months');
            shelf.innerHTML = '';
            const years = [...new Set(data.map(b => b.year))].sort((a,b) => b-a);
            years.forEach(y => {
                const yearBooks = data.filter(b => b.year === y);
                const months = [...new Set(yearBooks.map(b => b.month))].sort((a,b) => monthIndices[b] - monthIndices[a]);
                months.forEach(m => {
                    const group = document.createElement('div');
                    group.innerHTML = `<div class="group-title">${m} ${y}</div>`;
                    const grid = document.createElement('div');
                    grid.className = 'book-shelf';
                    yearBooks.filter(b => b.month === m).forEach(b => grid.appendChild(createCard(b)));
                    group.appendChild(grid);
                    shelf.appendChild(group);
                });
            });
        }

        function renderByAuthors(data) {
            const shelf = document.getElementById('shelf-authors');
            shelf.innerHTML = '';
            const allAuthors = [...new Set(data.flatMap(b => b.author.split(',').map(s => s.trim()).filter(Boolean)))].sort();
            allAuthors.forEach(a => {
                const group = document.createElement('div');
                group.innerHTML = `<div class="group-title">${a}</div>`;
                const grid = document.createElement('div');
                grid.className = 'book-shelf';
                data.filter(b => b.author.split(',').map(s => s.trim()).includes(a)).forEach(b => grid.appendChild(createCard(b)));
                group.appendChild(grid);
                shelf.appendChild(group);
            });
        }

        function renderByTags(data) {
            const shelf = document.getElementById('shelf-tags');
            shelf.innerHTML = '';
            const tags = [...new Set(data.flatMap(b => b.tags || []))].sort();
            tags.forEach(t => {
                const group = document.createElement('div');
                group.innerHTML = `<div class="group-title">${t}</div>`;
                const grid = document.createElement('div');
                grid.className = 'book-shelf';
                data.filter(b => (b.tags || []).includes(t)).forEach(b => grid.appendChild(createCard(b)));
                group.appendChild(grid);
                shelf.appendChild(group);
            });
        }

        function renderGoalTab() {
            const currentYear = new Date().getFullYear().toString();
            const yearBooks = books.filter(b => b.year === currentYear);
            const numRead = yearBooks.length;
            const container = document.getElementById('goal-grid-container');
            container.innerHTML = '';
            for (let i = 1; i <= currentYearGoal; i++) {
                const slot = document.createElement('div');
                slot.className = 'goal-slot';
                if (i <= numRead) {
                    const book = yearBooks[i-1];
                    slot.classList.add('filled');
                    slot.innerHTML = `<img src="${book.img}" onerror="this.style.display='none'"><div class="check-badge">${iconCheck}</div>`;
                    slot.onclick = () => window.viewBook(book.id);
                } else slot.innerText = i;
                container.appendChild(slot);
            }
            const footer = document.getElementById('goal-footer-info');
            const diff = currentYearGoal - numRead;
            footer.innerHTML = diff > 0 ? `<div class="goal-footer-main">${diff} ${getBooksNoun(diff)} до цели</div><div class="goal-footer-sub">Продолжайте читать!</div>` : `<div class="goal-footer-main" style="color: var(--tg-accent)">Цель достигнута! 🎉</div><div class="goal-footer-sub">Вы прочитали ${numRead} ${getBooksNoun(numRead)} в этом году.</div>`;
        }

        function getBooksNoun(n) {
            if (n % 10 === 1 && n % 100 !== 11) return 'книга';
            if ([2, 3, 4].includes(n % 10) && ![12, 13, 14].includes(n % 100)) return 'книги';
            return 'книг';
        }

        window.openGoalModal = () => {
            const modal = document.getElementById('goal-modal-overlay');
            document.getElementById('modal-title').innerText = "Годовая цель по чтению";
            document.getElementById('modal-content').innerHTML = `<div class="goal-input-box"><input type="number" id="goal-input-value" value="${currentYearGoal}" min="1"><span>книг в год</span><div class="goal-stepper"><button class="goal-stepper-btn" onclick="document.getElementById('goal-input-value').stepUp()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="18 15 12 9 6 15"></polyline></svg></button><button class="goal-stepper-btn" onclick="document.getElementById('goal-input-value').stepDown()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div></div>`;
            document.getElementById('modal-btns').className = "goal-modal-btns row";
            document.getElementById('modal-btns').innerHTML = `<button class="btn-goal-action btn-goal-cancel" onclick="window.closeGoalModal()">Отменить</button><button class="btn-goal-action btn-goal-save" onclick="window.saveGoalSettings()">OK</button>`;
            modal.classList.remove('hidden');
        };

        window.showDeferredMarkModal = (id) => {
            const modal = document.getElementById('goal-modal-overlay');
            document.getElementById('modal-title').innerText = "Вы уже прочитали книгу?";
            document.getElementById('modal-content').innerHTML = `<p style="margin-bottom:20px; font-size:14px; opacity:0.8">Хотите составить конспект?</p>`;
            document.getElementById('modal-btns').className = "goal-modal-btns";
            document.getElementById('modal-btns').innerHTML = `<button class="btn-goal-action btn-goal-save" onclick="window.handleDeferredAction('${id}', 'yes')">Да</button><button class="btn-goal-action btn-goal-cancel" onclick="window.handleDeferredAction('${id}', 'no')">Нет</button><button class="btn-goal-action btn-goal-gray" onclick="window.closeGoalModal()">Оставить в отложенных</button>`;
            modal.classList.remove('hidden');
        };

        window.handleDeferredAction = (id, choice) => {
            const book = deferredBooks.find(b => b.id === id);
            if (choice === 'yes') { window.openAddForm(null, book); }
            if (choice === 'yes' || choice === 'no') { deferredBooks = deferredBooks.filter(b => b.id !== id); localStorage.setItem('reading_journal_deferred', JSON.stringify(deferredBooks)); if (choice === 'no') renderDeferredShelf(); }
            window.closeGoalModal();
        };

        window.closeGoalModal = () => document.getElementById('goal-modal-overlay').classList.add('hidden');
        
        window.saveGoalSettings = () => {
            const val = parseInt(document.getElementById('goal-input-value').value);
            if (val && val > 0) { currentYearGoal = val; localStorage.setItem('reading_goal_v2', currentYearGoal); window.closeGoalModal(); renderGoalTab(); if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success'); }
        };

        window.openAddForm = (bookId = null, prefillData = null) => {
            currentEditingId = bookId; isDeferredMode = false; window.switchTab('add');
            document.getElementById('note-only-fields').classList.remove('hidden');
            document.getElementById('note-date-row').classList.remove('hidden');
            document.getElementById('f-source').classList.add('hidden');
            const yearSel = document.getElementById('f-year');
            if (yearSel.options.length === 0) { const cur = new Date().getFullYear(); for(let i=cur+2; i>=2000; i--) yearSel.add(new Option(i, i)); yearSel.value = cur; }
            const book = prefillData || (bookId ? books.find(b => b.id === bookId) : null);
            document.getElementById('f-title').value = book?.title || '';
            document.getElementById('f-author').value = book?.author || '';
            document.getElementById('f-genre').value = book?.genre || '';
            document.getElementById('f-tags').value = (book?.tags || []).join(', ');
            document.getElementById('selected-questions').innerHTML = '';
            selectedCoverBase64 = book?.img || null;
            document.getElementById('cover-preview-container').innerHTML = selectedCoverBase64 ? `<img src="${selectedCoverBase64}">` : `<span>+<br>Обложка</span>`;
            currentMediaFiles = book?.media || [];
            renderMediaEditList();
            document.getElementById('q-cloud').innerHTML = questionsPool.map(q => { const active = book && book.answers && book.answers[q]; return `<div class="q-chip ${active ? 'selected' : ''}" onclick="window.toggleQuestion(this, '${q}')">${q}</div>`; }).join('');
            document.getElementById('ratings-list').innerHTML = ratingCriteria.map((c, i) => { const val = (book && book.criteria) ? book.criteria[i] : 5; return `<div class="rating-row"><div class="rating-info"><span>${c}</span><span id="rv-${i}">${val}</span></div><input type="range" class="rating-slider" min="1" max="10" value="${val}" oninput="document.getElementById('rv-${i}').innerText=this.value"></div>`; }).join('');
            if (book && !prefillData) { document.getElementById('f-month').value = book.month; document.getElementById('f-year').value = book.year; if (book.answers) Object.entries(book.answers).forEach(([q, a]) => addQuestionItem(q, a, !questionsPool.includes(q))); }
        };

        window.openAddDeferredForm = (bookId = null) => {
            currentEditingId = bookId; isDeferredMode = true; window.switchTab('add');
            document.getElementById('note-only-fields').classList.add('hidden');
            document.getElementById('note-date-row').classList.add('hidden');
            document.getElementById('f-source').classList.remove('hidden');
            const book = bookId ? deferredBooks.find(b => b.id === bookId) : null;
            document.getElementById('f-title').value = book?.title || '';
            document.getElementById('f-author').value = book?.author || '';
            document.getElementById('f-genre').value = book?.genre || '';
            document.getElementById('f-tags').value = (book?.tags || []).join(', ');
            document.getElementById('f-source').value = book?.sourceLink || '';
            selectedCoverBase64 = book?.img || null;
            document.getElementById('cover-preview-container').innerHTML = selectedCoverBase64 ? `<img src="${selectedCoverBase64}">` : `<span>+<br>Обложка</span>`;
        };

        window.handleMediaUpload = (input) => {
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => { currentMediaFiles.push(e.target.result); renderMediaEditList(); };
                    reader.readAsDataURL(file);
                });
            }
        };

        function renderMediaEditList() {
            const container = document.getElementById('media-edit-container');
            container.innerHTML = currentMediaFiles.map((src, i) => `<div class="media-edit-item"><img src="${src}"><div class="media-del-btn" onclick="window.removeMedia(${i})">✕</div></div>`).join('');
        }

        window.removeMedia = (index) => { currentMediaFiles.splice(index, 1); renderMediaEditList(); };

        window.toggleQuestion = (el, q) => {
            el.classList.toggle('selected');
            const id = 'q-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, '');
            if (el.classList.contains('selected')) addQuestionItem(q, '', false);
            else document.getElementById(id)?.remove();
        };

        function addQuestionItem(q, val, isCustom) {
            const container = document.getElementById('selected-questions');
            const id = isCustom ? ('custom-' + Date.now() + Math.random()) : ('q-' + btoa(unescape(encodeURIComponent(q))).replace(/=/g, ''));
            if (!isCustom && document.getElementById(id)) return;
            const div = document.createElement('div');
            div.className = 'q-item';
            div.id = id;
            div.innerHTML = `<div class="q-header-row">${isCustom ? `<input type="text" class="custom-q-label-input" value="${q}" placeholder="Свой вопрос...">` : `<label>${q}</label>`}<div class="delete-q-btn" onclick="this.closest('.q-item').remove()">${iconTrash}</div></div><textarea placeholder="Ваш ответ...">${val}</textarea>`;
            container.appendChild(div);
        }

        window.addCustomQuestion = () => addQuestionItem('', '', true);

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { selectedCoverBase64 = e.target.result; document.getElementById('cover-preview-container').innerHTML = `<img src="${e.target.result}">`; };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.saveBook = () => {
            const title = document.getElementById('f-title').value.trim();
            if (!title) { 
                if (window.Telegram?.WebApp?.showAlert) Telegram.WebApp.showAlert('Пожалуйста, введите название книги');
                else alert('Пожалуйста, введите название книги');
                return; 
            }
            const authorRaw = document.getElementById('f-author').value.trim() || 'Неизвестный автор';
            const authorNormalized = authorRaw.split(',').map(a => a.trim()).filter(Boolean).join(', ');
            const commonData = { title, author: authorNormalized, genre: document.getElementById('f-genre').value.trim(), img: selectedCoverBase64 || '', tags: document.getElementById('f-tags').value.split(',').map(t => t.trim()).filter(t => t) };
            
            if (isDeferredMode) {
                const defData = { ...commonData, id: currentEditingId || Date.now().toString(), sourceLink: document.getElementById('f-source').value.trim() };
                if (currentEditingId) deferredBooks = deferredBooks.map(b => b.id === currentEditingId ? defData : b);
                else deferredBooks.unshift(defData);
                localStorage.setItem('reading_journal_deferred', JSON.stringify(deferredBooks));
                window.switchTab('deferred');
            } else {
                const criteria = Array.from(document.querySelectorAll('.rating-slider')).map(s => parseInt(s.value));
                const avg = (criteria.length > 0 ? (criteria.reduce((a,b) => a+b, 0) / criteria.length) : 0).toFixed(1);
                const answers = {};
                document.querySelectorAll('.q-item').forEach(item => {
                    const labelEl = item.querySelector('label') || item.querySelector('.custom-q-label-input');
                    const label = labelEl.tagName === 'INPUT' ? labelEl.value.trim() : labelEl.innerText;
                    const text = item.querySelector('textarea').value.trim();
                    if (label && text) answers[label] = text;
                });
                const noteData = { ...commonData, id: currentEditingId || Date.now().toString(), month: document.getElementById('f-month').value, year: document.getElementById('f-year').value, rating: avg, answers, criteria, media: currentMediaFiles, mediaMode: 'grid' };
                if (currentEditingId) books = books.map(b => b.id === currentEditingId ? noteData : b);
                else books.unshift(noteData);
                localStorage.setItem('reading_journal_v2', JSON.stringify(books));
                window.switchTab('all');
            }
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        };

        window.viewBook = (id) => {
            const b = books.find(x => x.id === id); if (!b) return;
            const container = document.getElementById('note-details');
            let qaHtml = ''; Object.entries(b.answers || {}).forEach(([q, a]) => { qaHtml += `<div class="note-qa-item"><span class="q">${q}</span><div class="a">${a}</div></div>`; });
            let ratingsHtml = `<div class="view-detailed-ratings"><div class="group-title">Детальный рейтинг</div>`;
            ratingCriteria.forEach((name, i) => { ratingsHtml += `<div class="view-rating-item"><span>${name}</span><span class="rating-badge-score">${b.criteria[i]}</span></div>`; });
            ratingsHtml += '</div>';
            
            let mediaHtml = '';
            if (b.media && b.media.length > 0) {
                const isGrid = (b.mediaMode || 'grid') === 'grid';
                mediaHtml = `<div class="view-media-header"><div class="group-title" style="margin:0">Медиа</div><div class="media-mode-switch"><button class="btn-mini-action ${isGrid ? 'fill' : ''}" onclick="window.updateMediaMode('${b.id}', 'grid')">${iconGrid}</button><button class="btn-mini-action ${!isGrid ? 'fill' : ''}" onclick="window.updateMediaMode('${b.id}', 'carousel')">${iconCarousel}</button></div></div><div class="${isGrid ? 'media-display-grid' : 'media-display-carousel'}">${b.media.map(src => `<div class="media-item" onclick="window.openLightbox('${src}')"><img src="${src}"></div>`).join('')}</div>`;
            }

            container.innerHTML = `<div class="view-header-flex"><div class="view-cover-fixed"><div class="rating-badge ${getRatingClass(b.rating)}">${parseFloat(b.rating).toFixed(1)}</div><div class="book-cover"><img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'"></div></div><div class="view-info-text"><h1>${b.title}</h1><h2>${b.author}</h2><div class="view-genre">${b.genre || ''}</div><div><span class="view-month">${b.month}</span> <span class="view-year">${b.year}</span></div><div class="view-tags-container">${(b.tags || []).map(t => `<span class="view-tag">#${t}</span>`).join('')}</div></div></div><div class="view-actions-side"><button class="btn-base btn-mini-action fill" onclick="window.openAddForm('${b.id}')">${iconEdit}</button><button class="btn-base btn-mini-action" onclick="window.exportPDF('${b.title}')">${iconPdf}</button><button class="btn-base btn-mini-action" onclick="window.deleteBook('${b.id}')">${iconTrash}</button></div><div class="note-qa">${qaHtml || '<p style="text-align:center; opacity:0.5">Нет заметок</p>'}</div>${mediaHtml}${ratingsHtml}`;
            isDeferredMode = false; window.switchTab('view');
        };

        window.updateMediaMode = (bookId, mode) => {
            const b = books.find(x => x.id === bookId);
            if (b) { b.mediaMode = mode; localStorage.setItem('reading_journal_v2', JSON.stringify(books)); window.viewBook(bookId); }
        };

        window.openLightbox = (src) => {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.remove('hidden');
        };

        window.viewDeferredBook = (id) => {
            const b = deferredBooks.find(x => x.id === id); if (!b) return;
            const container = document.getElementById('note-details');
            container.innerHTML = `<div class="view-header-flex"><div class="view-cover-fixed"><div class="book-cover"><img src="${b.img}" onerror="this.parentElement.style.background='#333'; this.style.display='none'"></div></div><div class="view-info-text"><h1>${b.title}</h1><h2>${b.author}</h2><div class="view-genre">${b.genre || ''}</div><div class="view-tags-container">${(b.tags || []).map(t => `<span class="view-tag">#${t}</span>`).join('')}</div></div></div><div class="view-actions-side"><button class="btn-base btn-mini-action fill" onclick="window.openAddDeferredForm('${b.id}')">${iconEdit}</button><button class="btn-base btn-mini-action" onclick="window.deleteDeferredBook('${b.id}')">${iconTrash}</button></div>`;
            isDeferredMode = true; window.switchTab('view');
        };

        window.openSource = (link) => { if (link) window.open(link, '_blank'); };
        
        window.deleteBook = (id) => { 
            books = books.filter(b => b.id !== id); 
            localStorage.setItem('reading_journal_v2', JSON.stringify(books)); 
            window.switchTab('all'); 
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        };

        window.deleteDeferredBook = (id) => { 
            deferredBooks = deferredBooks.filter(b => b.id !== id); 
            localStorage.setItem('reading_journal_deferred', JSON.stringify(deferredBooks)); 
            window.switchTab('deferred'); 
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        };

        window.exportPDF = async (name) => {
            const element = document.getElementById('note-details');
            document.body.classList.add('pdf-export-mode');
            const opt = { margin: 10, filename: `Reading_Note_${name.replace(/\s+/g, '_')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            try { await html2pdf().set(opt).from(element).save(); } finally { document.body.classList.remove('pdf-export-mode'); }
        };

        window.onload = () => {
            const saved = localStorage.getItem('reading_journal_v2'); if (saved) books = JSON.parse(saved);
            const savedDef = localStorage.getItem('reading_journal_deferred'); if (savedDef) deferredBooks = JSON.parse(savedDef);
            const savedGoal = localStorage.getItem('reading_goal_v2'); if (savedGoal) currentYearGoal = parseInt(savedGoal);
            
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
            
            window.switchTab('all');
        };
    </script>
</body>
</html>
